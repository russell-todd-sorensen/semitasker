<html><head>
<title>ns_adp - NaviServer Built-in
Commands </title>
<link rel="stylesheet" href=".././nsd.css" type="text/css">
</head>
<! -- Generated from file 'files/ns_adp.html' by tcllib/doctools with format 'html'
   -->
<! -- CVS: $Id$ ns_adp.n
   -->

<body>
<hr> [
  <a href=".././toc.html">Table Of Contents</a>
| <a href=".././index.html">Keyword Index</a>
] <hr>

<h1> ns_adp(n) 4.99  &quot;NaviServer Built-in
Commands&quot;</h1>
<h2><a name="name">NAME</a></h2>
<p>
<p> ns_adp - ADP introduction and operation 



<h2><a name="table_of_contents">TABLE OF CONTENTS</a></h2>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<a href="#table_of_contents">TABLE OF CONTENTS</a><br>
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#description">DESCRIPTION</a><br>
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#see_also">SEE ALSO</a><br>
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#keywords">KEYWORDS</a><br>
<h2><a name="description">DESCRIPTION</a></h2>
<p>

Several commands, normally beginning with the  ns_adp  prefix, are used
to support  Naviserver Dynamic Pages , or ADPs . ADPs are a server-side 
environment for embedding Tcl code within static text blocks
(typically HTML or XML). The Tcl code is normally delimited
within  &lt;%  and  %&gt;  or  &lt;%=  and  %&gt;  tags and can be used 
to generate additional text or for any other purpose, e.g., 
updating a database.

<p>
The  &lt;% ...script... %&gt;  is used for cases where
the result of the Tcl script is ignored while the  
&lt;%=...script %&gt;  syntax is used to append the script
result to the output buffer. In either case, the
ns_adp_puts  command can be used to add content to the
output buffer. A simple ADP file could contain:

<p><table><tr><td bgcolor=black>&nbsp;</td><td><pre class='sample'>

&lt;html&gt; 
&lt;head&gt;&lt;title&gt;Hello from &lt;%=[ns_info hostname]%&gt;&lt;/title&gt;&lt;/head&gt; 
&lt;body&gt;
Time is: &lt;%=Thu Jul 05 10:07:56 EDT 2007%&gt; 
Four links:
&lt;% for {set i 0} {$i &lt; 4} {incr i} { ns_adp_puts &quot;&lt;a href=/link/$i.htm&gt;Link $i&lt;/a&gt;&lt;br&gt;&quot; } %&gt; 
&lt;/body&gt;
&lt;/html&gt;
</pre></td></tr></table></p>

Accessing this page would generate output similar to:

<p><table><tr><td bgcolor=black>&nbsp;</td><td><pre class='sample'>
&lt;html&gt;
&lt;head&gt;&lt;title&gt;Hello from jgdavidson.local&lt;/title&gt;&lt;/head&gt; 
&lt;body&gt;
Time is: Mon Aug 01 22:15:18 EDT 2005 
Four links: &lt;a href=/link/0.htm&gt;Link 0&lt;/a&gt;&lt;br&gt; 
&lt;a href=/link/1.htm&gt;Link 1&lt;/a&gt;&lt;br&gt; 
&lt;a href=/link/2.htm&gt;Link 2&lt;/a&gt;&lt;br&gt; 
&lt;a href=/link/3.htm&gt;Link 3&lt;/a&gt;&lt;br&gt;
&lt;/body&gt;
&lt;/html&gt;

</pre></td></tr></table></p>

ADP processing normally occurs in the context of an HTTP transaction when
an URL request is mapped to an ADP file in the
server's page root. (see  ADP CONFIGURATION 
below for details on configuring this mapping). The ADP
request processing code allocates a Tcl interpreter and
includes the cooresponding ADP file. Output generated during
execution of the ADP is sent as a normal HTTP response,
using default status code of &quot;200 OK&quot; and the mime
type which corresponds to the ADP file extensions, normally
.adp and text/html (commands such as  ns_adp_mimetype 
can be used to control the eventual response type).

<p>

An ADP can include additional ADP files with the  ns_adp_include 
command or evaluate ADP text/script code directly with
 ns_adp_eval . This capability enables are large degree
of reuse of presentation and code between applications. Each
such included file or ADP string evaluation is performed in
it's own  call frame  similar to a Tcl procedure
with a local variable namespace. Arguments can be passed to
new call frames and then accessed with commands such as
 ns_adp_argv . When necessary, commands such as
 ns_adp_abort  provide limited support to interrupt
and/or return from within an ADP, unwinding the ADP call
stack to the underyling C-level request processing code.

<p>

Naviserver can be configured to execute ADP's placed with other static
files within a virtual server's pages directory via
the  map  parameter in the  adp  server config
section, for example:

<p><table><tr><td bgcolor=black>&nbsp;</td><td><pre class='sample'>

ns_section ns/server/server1/adp
ns_param map /*.adp ns_param map {/stories/*.adp 60}

</pre></td></tr></table></p>

The first map will evaluate all files which end in  .adp  and do not have
more specific mappings (such as the second map). The second
config map will execute files which end with  .adp 
located under the  /stories  directly and also
specifies a cache timeout in seconds. In this case, results
will be retained and returned to subsequent requests without
re-executing the ADP for up to 60 seconds (see the
 -cache  paramter to the  ns_adp_include  command
for more details).

<p>

Alternatively, arbitrary URL's may be mapped to individual ADP files
using the  ns_register_adp  command. This command would
normally be included in a virtual-server initialization
scripts within the  modules/tcl/  server
subdirectory.

<p>

By default, errors within an ADP script block are reported in the server log
and interrupt execution of the current block only;
subsequent text and script blocks continue to be processed
and and no error message is included in the output. This
approach is highly defensive and has the benefit of
generating a valid, if partial, responses after minor
errors. A negative aspect of this approach is that, without
careful monitoring of the server log, such errors can easily
be ignored.

<p>
The default error handling behavior can be modified by settings one or more
virtual-server configuration flags:

<p><table><tr><td bgcolor=black>&nbsp;</td><td><pre class='sample'>

ns_section ns/server/server1/adp
ns_param stricterror false; # Interrupt execution on any error.
ns_param displayerror false; # Include error message in output.
ns_param detailerror true; # Include connection details messages.

</pre></td></tr></table></p>

These flags, along with other options, can be queried or modified for an
individual ADP execution stream via the  ns_adp_ctl.

<p>

By default, each Tcl block is independent of other blocks and must be a
complete script. In particular, this means that conditional
code cannot span blocks, e.g., the following does not work
by default:

<p><table><tr><td bgcolor=black>&nbsp;</td><td><pre class='sample'>

&lt;% foreach elem $list { %&gt; Here is an &lt;%=$elem%&gt; element. &lt;% } %&gt;

</pre></td></tr></table></p>

This behavior can be changed with the  singlescript  config option or via
the  ns_adp_ctl  command which instructs the ADP parser
to converts all text/code blocks within an ADP into a single
Tcl script block:

<p><table><tr><td bgcolor=black>&nbsp;</td><td><pre class='sample'>
ns_section ns/server/server1/adp
ns_param singlescript false; # Combine code blocks into one scripts.

</pre></td></tr></table></p>

Setting this option would covert the script above into the following
equivalent:


<p><table><tr><td bgcolor=black>&nbsp;</td><td><pre class='sample'>

&lt;% 
  foreach elem $list { 
    ns_adp_puts -nonewline &quot;\n Here is an&quot;
    ns_adp_puts -nonewline $elem
    ns_adp_puts -nonewline &quot; element.\n&quot;
  } 
%&gt;

</pre></td></tr></table></p>

Note that this option combines scripts within a particular ADP file, it
does not combine scripts which span multiple included
ADP's. In addition, error semantics described above
apply to the combined script and any error within any block
combined into a single script will stop execution of the
entire included page.

<p>
Output including accumulated text blocks and output generated by Tcl script
blocks is normally buffered internally until the end of the
connection. Once complete, a single response is generated
which follows HTTP response headers indicating the resulting
content length. The content may optionally be gzip
compressed first.

<p>
Alternatively, an incremental response can be be generated either 
in response to calling the  ns_adp_stream  or  ns_adp_flush 
commands or automatically due to buffer overflow. In this
case, an HTTP response will be generated on the first flush
which specifies incremental content using HTTP/1.1
chunked-encoding. Forcing a connection into streaming mode
can be useful for certain long running requests where
it's reasonable to expect the browser can render
incremental respnoses.

<p>
The size of the internal buffer and gzip compression options can 
be set with corresponding server and ADP config options. Note both the
virtual-server wide gzip and ADP gzip options must be
enabled to support compression of ADP output.

<p><table><tr><td bgcolor=black>&nbsp;</td><td><pre class='sample'>

ns_section ns/server/server1/adp 
ns_param gzip true ;# Enable ADP output compression. 
ns_param bufsize 102400; # Buffer size, 1meg default.

</pre></td></tr></table></p>

The ADP interface uses the server's mimetype configuration 
to map file extensions to charsets and cooresponding encoding. This
configuration is necessary to ensure the file text and
script blocks are properly coverted to UTF-8 for use
internally. This mimetype is also used to set the character
output encoding although the  ns_conn encoding  option
can be used to override the encoding if necessary.





<h2><a name="see_also">SEE ALSO</a></h2>
<p>
<a href="ns_adp_ctl.html"> ns_adp_ctl </a>, <a href="ns_adp_include.html"> ns_adp_include </a>, <a href="ns_adp_puts.html"> ns_adp_puts </a>
<h2><a name="keywords">KEYWORDS</a></h2>
<p>
<a href="../index.html#key48"> ADP </a>
</body></html>

