<html><head>
<title>ns_db - NaviServer Built-in Commands </title>
<link rel="stylesheet" href=".././nsd.css" type="text/css">
</head>
<! -- Generated from file 'files/ns_db.html' by tcllib/doctools with format 'html'
   -->
<! -- CVS: $Id$ ns_db.n
   -->

<body>
<hr> [
  <a href=".././toc.html">Table Of Contents</a>
| <a href=".././index.html">Keyword Index</a>
] <hr>

<h1> ns_db(n) 4.99  &quot;NaviServer Built-in Commands&quot;</h1>
<h2><a name="name">NAME</a></h2>
<p>
<p> ns_db - Standard database access API




<h2><a name="table_of_contents">TABLE OF CONTENTS</a></h2>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<a href="#table_of_contents">TABLE OF CONTENTS</a><br>
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#synopsis">SYNOPSIS</a><br>
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#description">DESCRIPTION</a><br>
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#commands">COMMANDS</a><br>
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#examples">EXAMPLES</a><br>
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#see_also">SEE ALSO</a><br>
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#keywords">KEYWORDS</a><br>
<h2><a name="synopsis">SYNOPSIS</a></h2>
<p>
<table border=1 width=100% cellspacing=0 cellpadding=0><tr            bgcolor=lightyellow><td bgcolor=lightyellow><table 0 width=100% cellspacing=0 cellpadding=0><tr valign=top ><td ><a href="#1"><b class='cmd'><a href="ns_db.html"> ns_db </a></b> <i class='arg'>bindrow</i> <i class='arg'>dbhandle</i></a></td></tr>
<tr valign=top ><td ><a href="#2"><b class='cmd'><a href="ns_db.html"> ns_db </a></b> <i class='arg'>bouncepool</i> <i class='arg'>poolname</i></a></td></tr>
<tr valign=top ><td ><a href="#3"><b class='cmd'><a href="ns_db.html"> ns_db </a></b> <i class='arg'>cancel</i> <i class='arg'>dbhandle</i></a></td></tr>
<tr valign=top ><td ><a href="#4"><b class='cmd'><a href="ns_db.html"> ns_db </a></b> <i class='arg'>close</i> <i class='arg'>dbhandle</i></a></td></tr>
<tr valign=top ><td ><a href="#5"><b class='cmd'><a href="ns_db.html"> ns_db </a></b> <i class='arg'>connected</i> <i class='arg'>dbhandle</i></a></td></tr>
<tr valign=top ><td ><a href="#6"><b class='cmd'><a href="ns_db.html"> ns_db </a></b> <i class='arg'>datasource</i> <i class='arg'>dbhandle</i></a></td></tr>
<tr valign=top ><td ><a href="#7"><b class='cmd'><a href="ns_db.html"> ns_db </a></b> <i class='arg'>dbtype</i> <i class='arg'>dbhandle</i></a></td></tr>
<tr valign=top ><td ><a href="#8"><b class='cmd'><a href="ns_db.html"> ns_db </a></b> <i class='arg'>dml</i> <i class='arg'>dbhandle</i> <i class='arg'>sql</i></a></td></tr>
<tr valign=top ><td ><a href="#9"><b class='cmd'><a href="ns_db.html"> ns_db </a></b> <i class='arg'>driver</i> <i class='arg'>dbhandle</i></a></td></tr>
<tr valign=top ><td ><a href="#10"><b class='cmd'><a href="ns_db.html"> ns_db </a></b> <i class='arg'>exception</i> <i class='arg'>dbhandle</i></a></td></tr>
<tr valign=top ><td ><a href="#11"><b class='cmd'><a href="ns_db.html"> ns_db </a></b> <i class='arg'>exec</i> <i class='arg'>dbhandle</i> <i class='arg'>sqlcommand</i></a></td></tr>
<tr valign=top ><td ><a href="#12"><b class='cmd'><a href="ns_db.html"> ns_db </a></b> <i class='arg'>flush</i> <i class='arg'>dbhandle</i></a></td></tr>
<tr valign=top ><td ><a href="#13"><b class='cmd'><a href="ns_db.html"> ns_db </a></b> <i class='arg'>gethandle</i> ?<i class='arg'>-timeout</i>? <i class='arg'>poolname</i> ?<i class='arg'>nhandles</i>?</a></td></tr>
<tr valign=top ><td ><a href="#14"><b class='cmd'><a href="ns_db.html"> ns_db </a></b> <i class='arg'>getrow</i> <i class='arg'>dbhandle</i> <i class='arg'>setId</i></a></td></tr>
<tr valign=top ><td ><a href="#15"><b class='cmd'><a href="ns_db.html"> ns_db </a></b> <i class='arg'>open</i> <i class='arg'>driver</i> <i class='arg'>datasource</i> <i class='arg'>user</i> <i class='arg'>password</i></a></td></tr>
<tr valign=top ><td ><a href="#16"><b class='cmd'><a href="ns_db.html"> ns_db </a></b> <i class='arg'>poolname</i> <i class='arg'>dbhandle</i></a></td></tr>
<tr valign=top ><td ><a href="#17"><b class='cmd'><a href="ns_db.html"> ns_db </a></b> <i class='arg'>pools</i></a></td></tr>
<tr valign=top ><td ><a href="#18"><b class='cmd'><a href="ns_db.html"> ns_db </a></b> <i class='arg'>releasehandle</i> <i class='arg'>dbhandle</i></a></td></tr>
<tr valign=top ><td ><a href="#19"><b class='cmd'><a href="ns_db.html"> ns_db </a></b> <i class='arg'>1row</i> <i class='arg'>dbhandle</i> <i class='arg'>sql</i></a></td></tr>
<tr valign=top ><td ><a href="#20"><b class='cmd'><a href="ns_db.html"> ns_db </a></b> <i class='arg'>0or1row</i> <i class='arg'>dbhandle</i> <i class='arg'>sql</i></a></td></tr>
<tr valign=top ><td ><a href="#21"><b class='cmd'><a href="ns_db.html"> ns_db </a></b> <i class='arg'>password</i> <i class='arg'>dbhandle</i></a></td></tr>
<tr valign=top ><td ><a href="#22"><b class='cmd'><a href="ns_db.html"> ns_db </a></b> <i class='arg'>select</i> <i class='arg'>dbhandle</i> <i class='arg'>sql</i></a></td></tr>
<tr valign=top ><td ><a href="#23"><b class='cmd'><a href="ns_db.html"> ns_db </a></b> <i class='arg'>setexception</i> <i class='arg'>dbhandle</i> <i class='arg'>code</i> <i class='arg'>message</i></a></td></tr>
<tr valign=top ><td ><a href="#24"><b class='cmd'><a href="ns_db.html"> ns_db </a></b> <i class='arg'>sp_exec</i> <i class='arg'>dbhandle</i></a></td></tr>
<tr valign=top ><td ><a href="#25"><b class='cmd'><a href="ns_db.html"> ns_db </a></b> <i class='arg'>sp_getparams</i></a></td></tr>
<tr valign=top ><td ><a href="#26"><b class='cmd'><a href="ns_db.html"> ns_db </a></b> <i class='arg'>sp_returncode</i> <i class='arg'>dbhandle</i></a></td></tr>
<tr valign=top ><td ><a href="#27"><b class='cmd'><a href="ns_db.html"> ns_db </a></b> <i class='arg'>sp_setparam</i> <i class='arg'>dbhandle</i> <i class='arg'>varname</i> <i class='arg'>vartype</i> <i class='arg'>inout</i> <i class='arg'>value</i></a></td></tr>
<tr valign=top ><td ><a href="#28"><b class='cmd'><a href="ns_db.html"> ns_db </a></b> <i class='arg'>sp_start</i> <i class='arg'>dbhandle</i> <i class='arg'>procname</i></a></td></tr>
<tr valign=top ><td ><a href="#29"><b class='cmd'><a href="ns_db.html"> ns_db </a></b> <i class='arg'>user</i> <i class='arg'>dbhandle</i></a></td></tr>
<tr valign=top ><td ><a href="#30"><b class='cmd'><a href="ns_db.html"> ns_db </a></b> <i class='arg'>verbose</i> <i class='arg'>dbhandle</i> ?<i class='arg'>on | off</i>?</a></td></tr>
</table></td></tr></table>
<h2><a name="description">DESCRIPTION</a></h2>
<p>
This command provides a mechanism to access databases.

<h2><a name="commands">COMMANDS</a></h2>
<p>

<dl>

<dt><a name="1"><b class='cmd'><a href="ns_db.html"> ns_db </a></b> <i class='arg'>bindrow</i> <i class='arg'>dbhandle</i></a><dd>


ns_db bindrow returns an ns_set structure whose key names are the column names of the rows
returned by the SQL command previously-executed with ns_db exec. If the database is not 
currently returning rows (i.e., a status other than NS_ROWS was returned by ns_db exec),
an error is thrown. The dbhandle argument is a database handle (obtained with ns_db gethandle).

<br><br>
<dt><a name="2"><b class='cmd'><a href="ns_db.html"> ns_db </a></b> <i class='arg'>bouncepool</i> <i class='arg'>poolname</i></a><dd>


Marks all database handles for the specified database pool as stale. When any database
handle currently open is put back into the pool, its connection to the database will be reset.

<br><br>
<dt><a name="3"><b class='cmd'><a href="ns_db.html"> ns_db </a></b> <i class='arg'>cancel</i> <i class='arg'>dbhandle</i></a><dd>


ns_db cancel cancels the current operation.

<br><br>
<dt><a name="4"><b class='cmd'><a href="ns_db.html"> ns_db </a></b> <i class='arg'>close</i> <i class='arg'>dbhandle</i></a><dd>


Closes the connection. Use this function only on handles that were obtained by
the ns_db open function.  The server automatically close handles when the operation
is complete, so you don't normally have to call this function.

<br><br>
<dt><a name="5"><b class='cmd'><a href="ns_db.html"> ns_db </a></b> <i class='arg'>connected</i> <i class='arg'>dbhandle</i></a><dd>


ns_db connected returns a boolean value indicating whether the connection to the database pool is made.

<br><br>
<dt><a name="6"><b class='cmd'><a href="ns_db.html"> ns_db </a></b> <i class='arg'>datasource</i> <i class='arg'>dbhandle</i></a><dd>


Returns the datasource for the database pool.

<br><br>
<dt><a name="7"><b class='cmd'><a href="ns_db.html"> ns_db </a></b> <i class='arg'>dbtype</i> <i class='arg'>dbhandle</i></a><dd>


Returns the database type for the database pool.

<br><br>
<dt><a name="8"><b class='cmd'><a href="ns_db.html"> ns_db </a></b> <i class='arg'>dml</i> <i class='arg'>dbhandle</i> <i class='arg'>sql</i></a><dd>


ns_db dml executes SQL that should be data manipulation language such as an insert or
update, or data definition language such as a create table.

<br><br>
<dt><a name="9"><b class='cmd'><a href="ns_db.html"> ns_db </a></b> <i class='arg'>driver</i> <i class='arg'>dbhandle</i></a><dd>


Returns the name of the driver of the handle.

<br><br>
<dt><a name="10"><b class='cmd'><a href="ns_db.html"> ns_db </a></b> <i class='arg'>exception</i> <i class='arg'>dbhandle</i></a><dd>


ns_db exception returns the most recent exception for the database pool.

<br><br>
<dt><a name="11"><b class='cmd'><a href="ns_db.html"> ns_db </a></b> <i class='arg'>exec</i> <i class='arg'>dbhandle</i> <i class='arg'>sqlcommand</i></a><dd>


Executes the specified SQL command. It returns either NS_DML (if the SQL command is a DML
or DDL command) or NS_ROWS (if the SQL command returns rows, such as a SELECT).  This 
function can be used for ad hoc querying, where you don't know what kind of SQL command
will be executed.

<br><br>
<dt><a name="12"><b class='cmd'><a href="ns_db.html"> ns_db </a></b> <i class='arg'>flush</i> <i class='arg'>dbhandle</i></a><dd>


ns_db flush flushes the results of an SQL select so you do not need to use ns_db getrow
to get all the rows and throw them away.

<br><br>
<dt><a name="13"><b class='cmd'><a href="ns_db.html"> ns_db </a></b> <i class='arg'>gethandle</i> ?<i class='arg'>-timeout</i>? <i class='arg'>poolname</i> ?<i class='arg'>nhandles</i>?</a><dd>


ns_db gethandle returns the specified number of handles from the specified pool. If poolname is
not specified, the Defaultpool from the configuration file is used. If nhandles is not specified,
1 handle is returned. (Note that if you specify nhandles, you must also specify a poolname.) If 
not enough handles are available to fulfill the request, it waits until they are available. You 
must request all the handles you will need for a specific pool with one call to ns_db gethandle.
You must release all your database handles explicitly (with ns_db releasehandle) before acquiring
more. If you request multiple handles from the database, this function returns a Tcl list of database
handles (space delimited). In this case, each handle must be released with a separate call to ns_db
releasehandle.

<br><br>
If a timeout is not specified or timeout is zero, ns_db gethandle will wait indefinitely
(perhaps forever) for the requested number of handles to become available. If timeout is
greater than zero, ns_db gethandle will either return with the handles within that time
period, or return &quot;&quot; if the time period was exceeded, or generate a Tcl error of the form
&quot;could not allocate n handle(s) from pool 'poolname'. If timeout is less than zero, ns_db
gethandle will not block. It will either return with the handles, or generate the above Tcl
error. See the examples for ns_db gethandle, below.


<br><br>
<dt><a name="14"><b class='cmd'><a href="ns_db.html"> ns_db </a></b> <i class='arg'>getrow</i> <i class='arg'>dbhandle</i> <i class='arg'>setId</i></a><dd>


ns_db getrow fetches the next row waiting to be retrieved after an ns_db select.
The data is dumped right into the set associated with SETID, which should be the
set returned by the ns_db select. It returns &quot;1&quot; if there are more rows waiting 
and returns &quot;0&quot; otherwise. If you call ns_db getrow again after already receiving
&quot;0&quot; on the previous call, an error is returned.


<br><br>
<dt><a name="15"><b class='cmd'><a href="ns_db.html"> ns_db </a></b> <i class='arg'>open</i> <i class='arg'>driver</i> <i class='arg'>datasource</i> <i class='arg'>user</i> <i class='arg'>password</i></a><dd>


ns_db open returns a handle at a lower level, circumventing the pools.

<br><br>
<dt><a name="16"><b class='cmd'><a href="ns_db.html"> ns_db </a></b> <i class='arg'>poolname</i> <i class='arg'>dbhandle</i></a><dd>


ns_db poolname returns the database pool that this handle came from.

<br><br>
<dt><a name="17"><b class='cmd'><a href="ns_db.html"> ns_db </a></b> <i class='arg'>pools</i></a><dd>


ns_db pools returns a list of all database pools.

<br><br>
<dt><a name="18"><b class='cmd'><a href="ns_db.html"> ns_db </a></b> <i class='arg'>releasehandle</i> <i class='arg'>dbhandle</i></a><dd>


Puts the handle back in the pool.  The server will automatically return any open handles to
the pool after a page has finished executing.

<br><br>
<dt><a name="19"><b class='cmd'><a href="ns_db.html"> ns_db </a></b> <i class='arg'>1row</i> <i class='arg'>dbhandle</i> <i class='arg'>sql</i></a><dd>


This command expects the SQL to be a select statement that returns exactly one row and
returns that row as an ns_set.  An error is returned if zero or more than one row is returned.

<br><br>
<dt><a name="20"><b class='cmd'><a href="ns_db.html"> ns_db </a></b> <i class='arg'>0or1row</i> <i class='arg'>dbhandle</i> <i class='arg'>sql</i></a><dd>


This command expects the SQL to be a select statement that returns exactly zero or one row.
On zero rows, a null string is returned. On one row, a newly allocated ns_set is returned. 
An error is thrown if more then one row is returned.

<br><br>
<dt><a name="21"><b class='cmd'><a href="ns_db.html"> ns_db </a></b> <i class='arg'>password</i> <i class='arg'>dbhandle</i></a><dd>


Returns the password of the user for the database pool.

<br><br>
<dt><a name="22"><b class='cmd'><a href="ns_db.html"> ns_db </a></b> <i class='arg'>select</i> <i class='arg'>dbhandle</i> <i class='arg'>sql</i></a><dd>


ns_db select executes the SQL statement on the database server. It returns an ns_set
with the keys set to the column names that were selected. Use ns_db getrow to retrieve
rows. You cannot perform nested select statements. Before you start a new select statement,
you must first either retrieve all the rows from the first select or use the ns_db flush 
statement to flush any rows not yet retrieved.

<br><br>
<dt><a name="23"><b class='cmd'><a href="ns_db.html"> ns_db </a></b> <i class='arg'>setexception</i> <i class='arg'>dbhandle</i> <i class='arg'>code</i> <i class='arg'>message</i></a><dd>


ns_db setexception returns the specified status code and message to the client.

<br><br>
<dt><a name="24"><b class='cmd'><a href="ns_db.html"> ns_db </a></b> <i class='arg'>sp_exec</i> <i class='arg'>dbhandle</i></a><dd>


ns_db sp_exec executes a stored procedure that has been initialized with ns_db sp_start
and ns_db sp_setparam. It returns &quot;NS_DML&quot; if the command was succsesfully executed but
did not return rows, or it returns &quot;NS_ROWS&quot; if the command was successfully executed and
did return rows (which can then be fetched with ns_db bindrow and ns_db getrow). It throws
an error if the command failed. This function is implemented only for the Sybase database 
driver. See the Examples section, below, for an example of this function.

<br><br>
<dt><a name="25"><b class='cmd'><a href="ns_db.html"> ns_db </a></b> <i class='arg'>sp_getparams</i></a><dd>


ns_db sp_getparams gets any output parameters set after executing a stored
procedure with ns_db sp_exec. It returns an ns_set or throws an error on failure.
This function is implemented only for the Sybase database driver. See the Examples
section, below, for an example of this function.

<br><br>
<dt><a name="26"><b class='cmd'><a href="ns_db.html"> ns_db </a></b> <i class='arg'>sp_returncode</i> <i class='arg'>dbhandle</i></a><dd>


ns_db sp_returncode gets the return code from a stored procedure. It must be called after
ns_db sp_exec. This function is implemented only for the Sybase database driver. See the 
Examples section, below, for an example of this function.

<br><br>
<dt><a name="27"><b class='cmd'><a href="ns_db.html"> ns_db </a></b> <i class='arg'>sp_setparam</i> <i class='arg'>dbhandle</i> <i class='arg'>varname</i> <i class='arg'>vartype</i> <i class='arg'>inout</i> <i class='arg'>value</i></a><dd>


ns_db sp_setparam sets a parameter for a call to a stored procedure. The varname is the name of the variable,
for example &quot;@name&quot;. The vartype is the data type of this parameter, for example &quot;varchar&quot;. The inout argument
indicates whether it's an input or output parameter. It must be set to either &quot;in&quot; or &quot;out&quot;. The value is the 
paramter value to send. This function returns 1 on success and throws an error on failure. This function is 
implemented only for the Sybase database driver. See the Examples section, below, for an example of this function.


<br><br>
<dt><a name="28"><b class='cmd'><a href="ns_db.html"> ns_db </a></b> <i class='arg'>sp_start</i> <i class='arg'>dbhandle</i> <i class='arg'>procname</i></a><dd>


ns_db sp_start begins execution of the stored procedure called procname. It returns 0 on success and throws
an error on failure. This function is implemented only for the Sybase database driver. See the Examples section,
below, for an example of this function.

<br><br>
<dt><a name="29"><b class='cmd'><a href="ns_db.html"> ns_db </a></b> <i class='arg'>user</i> <i class='arg'>dbhandle</i></a><dd>


Returns the user (as specified for the User parameter of the configuration file) for the database pool.

<br><br>
<dt><a name="30"><b class='cmd'><a href="ns_db.html"> ns_db </a></b> <i class='arg'>verbose</i> <i class='arg'>dbhandle</i> ?<i class='arg'>on | off</i>?</a><dd>


ns_db verbose changes the verbose setting (the Verbose parameter in the configuration file) for the database pool.

</dl>

<h2><a name="examples">EXAMPLES</a></h2>
<p>

These are valid uses of ns_db gethandle:

<p><table><tr><td bgcolor=black>&nbsp;</td><td><pre class='sample'>

    ns_db gethandle 
    # 1 handle from default pool
    ns_db gethandle -timeout 23 
    # 1 handle from default pool, 23 sec timeout
    ns_db gethandle -timeout -1 poolname
    # 1 handle from poolname, error if not available
    ns_db gethandle poolname 
    # 1 handle from poolname
    ns_db gethandle -timeout 23 poolname 
    # 1 handle from poolname, 23 sec timeout
    ns_db gethandle poolname 5            
    # 5 handles from poolname
    ns_db gethandle -timeout 23 poolname 5 
    # 5 handles from poolname, 23 sec timeout
</pre></td></tr></table></p>

<p><table><tr><td bgcolor=black>&nbsp;</td><td><pre class='sample'>

  set db [ns_db gethandle  $pool]
  set ret [ns_db sp_start $db &quot;p_TestProc&quot;]

  #
  # Set the parameters for this stored procedure.  The SQL definition of this
  # procedure is:
  #
  #   CREATE PROCEDURE p_TestProc(@x int, @y varchar(16) out, @z int out)
  #
  # The arguments to ns_db sp_setparam are like this:
  #
  #   ns_db setparam $dbhandle $varname, $vartype, in|out, $value
  #
  set ret [ns_db sp_setparam $db &quot;@x&quot; int in 4]
  set ret [ns_db sp_setparam $db &quot;@y&quot; varchar out &quot;varchar val&quot;]
  set ret [ns_db sp_setparam $db &quot;@z&quot; int out 231]
    
  #
  # Execute the stored procedure now
  #
  set ret [ns_db sp_exec $db]

</pre></td></tr></table></p>






<h2><a name="see_also">SEE ALSO</a></h2>
<p>
<a href="../index.html#key527"> nsd </a>
<h2><a name="keywords">KEYWORDS</a></h2>
<p>
<a href="../index.html#key56"> ns_buildsqldate </a>, <a href="../index.html#key60"> ns_buildsqltime </a>, <a href="../index.html#key51"> ns_buildsqltimestamp </a>, <a href="../index.html#key54"> ns_dbquotename </a>, <a href="../index.html#key53"> ns_dbquotevalue </a>, <a href="../index.html#key59"> ns_localsqltimestamp </a>, <a href="../index.html#key52"> ns_parsesqldate </a>, <a href="../index.html#key55"> ns_parsesqltime </a>, <a href="../index.html#key58"> ns_parsesqltimestamp </a>, <a href="../index.html#key57"> ns_writecsv </a>
</body></html>

