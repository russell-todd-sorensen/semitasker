#[comment {
#   Testing file for glob-to and file-to commands
#
#   Note: file-to and glob-to are dangerous commands
#   which should probably be removed from safe templates.
#
#}/]

set directory $page
set dir $directory
set title "Index of $url"
set shortTitle "Index of [file tail $url]"
set mainCssExists [file exists [file join $dir main.css]]
set title $url

if {$mainCssExists} {
 set mainCss "main.css"
} else {
 set mainCss "/services/index/main-index.css"
}

append __string "<html lang='en-US'>
<head>
<meta charset='utf-8'>
<title>$title</title>
<link rel='stylesheet' type='text/css' href='$mainCss' media='all'>
<style type='text/css'>

table.dir {
    margin: 10px;
}

table.dir th, 
table.files th {
  text-align: left;
  background-color: silver;
  text-transform: capitalize;
  font-weight: bold;
  padding-right: 10px;
}

table.dir td,
table.files td {
  padding-right: 30px;
}

table.dir td a {
  padding-left: 30px;
}

.num {
  text-align: right;
}
</style>

 <script src='/js/jquery-3.1.1.js'></script>
 
</head>
<body>
<div class='nav'>
  <li><a href='/'>home page</a> &gt;</li>
"

set path "/"
foreach element $urlv {
  append path $element "/"
  append __string "  <li><a href='$path'>$element</a> &gt;</li>
"
}
  
append __string "  <li>$shortTitle</li>
</div>

<div id='content'>
 <h1 id='title'>$shortTitle</h1>
"

set file_list [lsort [glob -nocomplain -directory $directory/ -type f * ]]
set dir_list  [lsort [glob -nocomplain -directory $directory/ -type d * .* ]]

append __string "
<table class='dir' cellspacing='0' cellpadding='2' border='0'>
 <tr>
  <th>directories</th>
  <th>last modified</th>
  <th>exact</th>
  <th>bytes</th>
 </tr>"
 
foreach dirname $dir_list {
     set tail [file tail $dirname]
     file stat $dirname dirArray
     append __string "
  <tr>
   <td><a href='${tail}/' class='dir'><nobr>$tail</nobr></a></td>
   <td><nobr>[clock format $dirArray(mtime) -format "%Y-%m-%d %H:%M:%S" ]</nobr></td>
   <td class='num'>$dirArray(size)</td>
   <td class='num'>Bytes</td>
 </tr>
"
}
append __string "
 <tr>
  <th>files</th>
  <th>last modified</th>
  <th>exact</th>
  <th>size</th>
 </tr>"
 
foreach obj $file_list {
    set tail [file tail $obj]
    file stat $obj fileArray
    set file_extension [string trimleft [file extension $tail ] "."]
    set size $fileArray(size)
    set sizeOriginal $size

    switch -glob -- "$file_extension" {
        "*~" - "*.o" {
        }
        default {
            append __string "
  <tr>
   <td><a href='${tail}' class='$file_extension'><nobr>[string range $tail 0 50]</nobr></a></td>
   <td><nobr>[clock format $fileArray(mtime) -format "%Y-%m-%d %H:%M:%S" ]</nobr></td>
   <td class='num'>$sizeOriginal</td>
   <td class='num'><nobr>"

            if {$size  <= 1024 } {
                append __string "Bytes"
            } elseif {($size / 1024.0) <= 1024} {
                set size [expr {$size/1024}]
                set size [format %3d $size]
                append __string "[string map {" " "&nbsp;"} $size] KB"
            } elseif {($size / (1024*1024)) <= 1024} {
                append __string "[expr {$size/(1024*1024)} ] MB"
            }
            append __string "</nobr></td>
  </tr>"

       }
    }
}

append __string "
</table>
</div>

<div class='bottom'>
 <hr>
 <address><a href='mailto:russell@highfivediet.com'>Russell Sorensen</a></address>
 "
set script [info script]
set mtime [file mtime $script]
set clockTime [clock format $mtime -format "%+"]

append __string "
<!-- Created $clockTime -->

<span class='lastMod'>Last modified $clockTime</span>
 <div id='footer'>
  <div class='nav'>
   <li>\[<a href='..'>..</a>\] |</li>
   <li>\[<a href='.'>.</a>\]</li>
  </div>
 </div>
</div>
</body>
</html>"