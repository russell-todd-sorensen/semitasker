
<!-- saved from url=(0111)https://web.archive.org/web/20050120114850/http://www.zmbh.com/daemontools-aolserver/daemontools-aolserver.html -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">


<script type="text/javascript" src="./AOLserver+Daemontools Mini-HOWTO_files/analytics.js"></script>
<script type="text/javascript">archive_analytics.values.server_name="wwwb-app15.us.archive.org";archive_analytics.values.server_ms=190;</script>
<link type="text/css" rel="stylesheet" href="./AOLserver+Daemontools Mini-HOWTO_files/banner-styles.css">

<title>AOLserver+Daemontools Mini-HOWTO</title><link rel="STYLESHEET" type="text/css" href="./AOLserver+Daemontools Mini-HOWTO_files/ad.css"><meta name="GENERATOR" content="Modular DocBook HTML Stylesheet Version 1.60"></head><body class="ARTICLE" bgcolor="#FFFFFF" text="#000000" link="#0000FF" vlink="#840084" alink="#0000FF"><div id="wm-ipp" lang="en" style="display: block;">

<div style="position:fixed;left:0;top:0;width:100%!important">
<div id="wm-ipp-inside">
   <table style="width:100%;"><tbody><tr>
   <td id="wm-logo">
       <a href="https://web.archive.org/web/" title="Wayback Machine home page"><img src="./AOLserver+Daemontools Mini-HOWTO_files/wayback-toolbar-logo.png" alt="Wayback Machine" width="110" height="39" border="0"></a>
   </td>
   <td class="c">
       <table style="margin:0 auto;"><tbody><tr>
       <td class="u" colspan="2">
       <form target="_top" method="get" action="https://web.archive.org/web/form-submit.jsp" name="wmtb" id="wmtb"><input type="text" name="url" id="wmtbURL" value="http://www.zmbh.com/daemontools-aolserver/daemontools-aolserver.html" style="width:400px;" onfocus="this.focus();this.select();"><input type="hidden" name="type" value="replay"><input type="hidden" name="date" value="20050120114850"><input type="submit" value="Go"><span id="wm_tb_options" style="display:block;"></span></form>
       </td>
       <td class="n" rowspan="2">
           <table><tbody>
           <!-- NEXT/PREV MONTH NAV AND MONTH INDICATOR -->
           <tr class="m">
           	<td class="b" nowrap="nowrap">
		
		    <a href="https://web.archive.org/web/20041021021334/http://www.zmbh.com/daemontools-aolserver/daemontools-aolserver.html" title="21 Oct 2004">OCT</a>
		
		</td>
		<td class="c" id="displayMonthEl" title="You are here: 11:48:50 Jan 20, 2005">JAN</td>
		<td class="f" nowrap="nowrap">
		
		    <a href="https://web.archive.org/web/20061126125310/http://zmbh.com/daemontools-aolserver/daemontools-aolserver.html" title="26 Nov 2006"><strong>NOV</strong></a>
		
                </td>
	    </tr>
           <!-- NEXT/PREV CAPTURE NAV AND DAY OF MONTH INDICATOR -->
           <tr class="d">
               <td class="b" nowrap="nowrap">
               
                   <a href="https://web.archive.org/web/20041021021334/http://www.zmbh.com/daemontools-aolserver/daemontools-aolserver.html" title="2:13:34 Oct 21, 2004"><img src="./AOLserver+Daemontools Mini-HOWTO_files/wm_tb_prv_on.png" alt="Previous capture" width="14" height="16" border="0"></a>
               
               </td>
               <td class="c" id="displayDayEl" style="width:34px;font-size:24px;" title="You are here: 11:48:50 Jan 20, 2005">20</td>
	       <td class="f" nowrap="nowrap">
               
		   <a href="https://web.archive.org/web/20061126125310/http://zmbh.com/daemontools-aolserver/daemontools-aolserver.html" title="12:53:10 Nov 26, 2006"><img src="./AOLserver+Daemontools Mini-HOWTO_files/wm_tb_nxt_on.png" alt="Next capture" width="14" height="16" border="0"></a>
	       
	       </td>
           </tr>
           <!-- NEXT/PREV YEAR NAV AND YEAR INDICATOR -->
           <tr class="y">
	       <td class="b" nowrap="nowrap">
               
                   2004
               
               </td>
               <td class="c" id="displayYearEl" title="You are here: 11:48:50 Jan 20, 2005">2005</td>
	       <td class="f" nowrap="nowrap">
               
	           <a href="https://web.archive.org/web/20061126125310/http://zmbh.com/daemontools-aolserver/daemontools-aolserver.html" title="26 Nov 2006"><strong>2006</strong></a>
	       
	       </td>
           </tr>
           </tbody></table>
       </td>
       </tr>
       <tr>
       <td class="s">
           <a class="t" href="https://web.archive.org/web/20050120114850*/http://www.zmbh.com/daemontools-aolserver/daemontools-aolserver.html" title="See a list of every capture for this URL">8 captures</a>
           <div class="r" title="Timespan for captures of this URL">31 Aug 04 - 11 Oct 08</div>
       </td>
       <td class="k">
       <a href="https://web.archive.org/web/20050120114850/http://www.zmbh.com/daemontools-aolserver/daemontools-aolserver.html" id="wm-graph-anchor">
       <div id="wm-ipp-sparkline" title="Explore captures for this URL">
	 <img id="sparklineImgId" alt="sparklines" onmouseover="__wm.st(1)" onmouseout="__wm.st(0)" onmousemove="__wm.mv(event,this)" width="525" height="27" border="0" src="./AOLserver+Daemontools Mini-HOWTO_files/graph.jsp">
       <div class="yt" style="display: none; width: 25px; height: 27px;"></div><div class="mt" style="display: none; width: 2px; height: 27px;"></div></div>
       </a>
       </td>
       </tr></tbody></table>
   </td>
   <td class="r">
       <a href="https://web.archive.org/web/20050120114850/http://www.zmbh.com/daemontools-aolserver/daemontools-aolserver.html#close" onclick="__wm.h();return false;" style="background-image:url(/static/images/toolbar/wm_tb_close.png);top:5px;" title="Close the toolbar">Close</a>
       <a href="http://faq.web.archive.org/" style="background-image:url(/static/images/toolbar/wm_tb_help.png);bottom:5px;" title="Get some help using the Wayback Machine">Help</a>
   </td>
   </tr></tbody></table>
</div>
</div>
</div>


<!-- BEGIN WAYBACK TOOLBAR INSERT -->
<script type="text/javascript" src="./AOLserver+Daemontools Mini-HOWTO_files/disclaim-element.js"></script>
<script type="text/javascript" src="./AOLserver+Daemontools Mini-HOWTO_files/graph-calc.js"></script>
<script type="text/javascript">//<![CDATA[
var __wm = (function(imgWidth,imgHeight,yearImgWidth,monthImgWidth){
var wbPrefix = "/web/";
var wbCurrentUrl = "http://www.zmbh.com/daemontools-aolserver/daemontools-aolserver.html";

var firstYear = 1996;
var displayDay = "20";
var displayMonth = "Jan";
var displayYear = "2005";
var prettyMonths = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
var $D=document,$=function(n){return document.getElementById(n)};
var trackerVal,curYear = -1,curMonth = -1;
var yearTracker,monthTracker;
function showTrackers(val) {
  if (val===trackerVal) return;
  var $ipp=$("wm-ipp");
  var $y=$("displayYearEl"),$m=$("displayMonthEl"),$d=$("displayDayEl");
  if (val) {
    $ipp.className="hi";
  } else {
    $ipp.className="";
    $y.innerHTML=displayYear;$m.innerHTML=displayMonth;$d.innerHTML=displayDay;
  }
  yearTracker.style.display=val?"inline":"none";
  monthTracker.style.display=val?"inline":"none";
  trackerVal = val;
}
function trackMouseMove(event,element) {
  var eventX = getEventX(event);
  var elementX = getElementX(element);
  var xOff = Math.min(Math.max(0, eventX - elementX),imgWidth);
  var monthOff = xOff % yearImgWidth;

  var year = Math.floor(xOff / yearImgWidth);
  var monthOfYear = Math.min(11,Math.floor(monthOff / monthImgWidth));
  // 1 extra border pixel at the left edge of the year:
  var month = (year * 12) + monthOfYear;
  var day = monthOff % 2==1?15:1;
  var dateString = zeroPad(year + firstYear) + zeroPad(monthOfYear+1,2) +
    zeroPad(day,2) + "000000";

  $("displayYearEl").innerHTML=year+firstYear;
  $("displayMonthEl").innerHTML=prettyMonths[monthOfYear];
  // looks too jarring when it changes..
  //$("displayDayEl").innerHTML=zeroPad(day,2);
  var url = wbPrefix + dateString + '/' +  wbCurrentUrl;
  $("wm-graph-anchor").href=url;

  if(curYear != year) {
    var yrOff = year * yearImgWidth;
    yearTracker.style.left = yrOff + "px";
    curYear = year;
  }
  if(curMonth != month) {
    var mtOff = year + (month * monthImgWidth) + 1;
    monthTracker.style.left = mtOff + "px";
    curMonth = month;
  }
}
function hideToolbar() {
  $("wm-ipp").style.display="none";
}
function bootstrap() {
  var $spk=$("wm-ipp-sparkline");
  yearTracker=$D.createElement('div');
  yearTracker.className='yt';
  with(yearTracker.style){
    display='none';width=yearImgWidth+"px";height=imgHeight+"px";
  }
  monthTracker=$D.createElement('div');
  monthTracker.className='mt';
  with(monthTracker.style){
    display='none';width=monthImgWidth+"px";height=imgHeight+"px";
  }
  $spk.appendChild(yearTracker);
  $spk.appendChild(monthTracker);

  var $ipp=$("wm-ipp");
  $ipp&&disclaimElement($ipp);
}
return{st:showTrackers,mv:trackMouseMove,h:hideToolbar,bt:bootstrap};
})(525, 27, 25, 2);//]]>
</script>
<style type="text/css">
body {
  margin-top:0 !important;
  padding-top:0 !important;
  min-width:800px !important;
}
</style>

<script type="text/javascript">__wm.bt();</script>
<!-- END WAYBACK TOOLBAR INSERT -->
<div class="ARTICLE"><div class="TITLEPAGE"><h1 class="TITLE"><a name="AEN1">AOLserver+Daemontools Mini-HOWTO</a></h1><hr></div><div class="SECT1"><h1 class="SECT1"><a name="AOLSERVER-PLUS-DOEMONTOOLS"></a></h1><div class="SECT2"><h2 class="SECT2"><a name="APD-INTRO">Introduction</a></h2><p><a href="https://web.archive.org/web/20050120114850/http://cr.yp.to/daemontools.html" target="_top">Daemontools</a> is a collection of 
programs written and maintained by 
Dan Bernstein. Togeather the programs can be used to start, supervise
and control other programs. Daemontools can be used as a robust replacement
for inetd. </p><p><a href="https://web.archive.org/web/20050120114850/http://aolserver.com/" target="_top">AOLserver</a> is a multi-threaded, 
high-performance webserver. Like any piece of software
it occasionally gets out of wack and needs to be restarted. Sometimes it just needs to
be stopped so a bigger problem can be fixed. AOLserver is usually used on larger websites
where multiple developers need to restart or otherwise control the server.  </p><p>The following document will detail how to install and configure the daemontools to 
allow members of a given unix/linux group to control an AOLserver. </p></div><div class="SECT2"><h2 class="SECT2"><a name="APD-SOFTWARE">Obtaining the software</a></h2><p>The newest release of daemontools is available from:
<a href="https://web.archive.org/web/20050120114850/http://cr.yp.to/daemontools/install.html" target="_top">http://cr.yp.to/daemontools/install.html</a>
As of this writing, the latest version was <tt class="COMPUTEROUTPUT">daemontools-0.70.tar.gz</tt>.</p></div><div class="SECT2"><h2 class="SECT2"><a name="APD-INSTALL">Installing the Daemontools Package</a></h2><p>Unpack the daemontools package:

</p><pre class="PROGRAMLISTING">  gunzip daemontools-0.70.tar.gz
  tar -xf daemontools-0.70.tar
  cd daemontools-0.70</pre>	<p></p><p>The default installation directory is <tt class="COMPUTEROUTPUT">/usr/local</tt>. You can change this
by editing the first line of the <tt class="COMPUTEROUTPUT">conf-home</tt> file at this time.</p><p>Compile the programs:

</p><pre class="PROGRAMLISTING">  $ make</pre>	<p></p><p>And, as root install the daemontools programs:

</p><pre class="PROGRAMLISTING">  # make setup check</pre>	<p></p><p>Run a test to check if everything is working so far:

</p><pre class="PROGRAMLISTING">  $ ./rts &gt; rts.out
  $ cmp rts.out rts.exp</pre><p></p><p>Which should not produce any output if things are working. According to
DJB, some SVR4 varients fail the 'already locked' tests. You can ignore this
failure.</p><p><tt class="COMPUTEROUTPUT">svscan</tt> 
looks for programs to start by examining the <tt class="COMPUTEROUTPUT">/service</tt> directory.
You need to create this directory if it doesn't already exist.</p><pre class="PROGRAMLISTING">  # mkdir /service
  # chmod 755 /service</pre></div><div class="SECT2"><h2 class="SECT2"><a name="AEN35">Starting <tt class="COMPUTEROUTPUT">svscan</tt> at boot time</a></h2><p>Daemontools includes the <tt class="COMPUTEROUTPUT">supervise</tt> program, which is directly responsible for
watching over your AOLserver. Another program called <tt class="COMPUTEROUTPUT">svscan</tt> is responsible for 
starting <tt class="COMPUTEROUTPUT">supervise</tt>. This is convenient, because you only have to arrange for 
<tt class="COMPUTEROUTPUT">svscan</tt> to start at boot time. Adding more than one AOLserver does not require 
you to modify your startup scripts. Here is how you can install <tt class="COMPUTEROUTPUT">svscan</tt> to startup
at boot time. Place the following at the end of your <tt class="COMPUTEROUTPUT">/etc/rc.d/rc.local</tt> file. </p><pre class="PROGRAMLISTING">   env - PATH=/usr/local/bin:/usr/sbin:/usr/bin:/bin csh -cf 'svscan /service &amp;'</pre><p>This file is usually one of the last files to be sourced during startup, so networking
and other required services, like your databases, will have already started up. 
You should reboot to verify that <tt class="COMPUTEROUTPUT">svscan</tt> is running. 
If you changed the default 
installation directory, you will need to modify the above command.  </p></div><div class="SECT2"><h2 class="SECT2"><a name="APD-START-SCRIPT">Creating the <tt class="COMPUTEROUTPUT">run</tt> startup script</a></h2><p>The next step is to decide where to place your startup script for AOLserver. If you are using 
the ArsDigita Community System, a likely choice might be <tt class="COMPUTEROUTPUT">/web/servername/</tt>. 
AOLserver is usually
installed in <tt class="COMPUTEROUTPUT">/usr/local/aolserver</tt>, 
so a good location for the <tt class="COMPUTEROUTPUT">run</tt> script would be in 
<tt class="COMPUTEROUTPUT">/usr/local/aolserver/servers/servername/</tt>.</p><p>The <tt class="COMPUTEROUTPUT">run</tt> script will contain at least the following lines:</p><pre class="PROGRAMLISTING">#!/bin/sh 

exec /usr/local/aolserver/bin/nsd -ic /usr/local/aolserver/servername.ini -u username -g group</pre><p>Where you substitute the correct path to your <tt class="COMPUTEROUTPUT">nsd</tt> and configuration file. The above line is for the older <tt class="COMPUTEROUTPUT">.ini</tt> format file. The newer tcl format would look more like this:</p><pre class="PROGRAMLISTING">#!/bin/sh 

exec /usr/local/aolserver/bin/nsd -it /usr/local/aolserver/servername.tcl -u username -g group</pre><p>Once setup change the permission to 700, with owner and group set to root:</p><pre class="PROGRAMLISTING">-rwx------   1 root     root          435 Oct  1 20:00 run </pre><p>Shutdown your AOLserver process, and you will be ready to try out your script.</p></div><div class="SECT2"><h2 class="SECT2"><a name="APD-SVSCAN">Telling <tt class="COMPUTEROUTPUT">svscan</tt> about AOLserver</a></h2><p>With the startup script ready, you need to tell <tt class="COMPUTEROUTPUT">svscan</tt> 
about your AOLserver <tt class="COMPUTEROUTPUT">run</tt> script.
You do this by creating a symbolic link from the directory where your 
<tt class="COMPUTEROUTPUT">run</tt> script lives, to the 
<tt class="COMPUTEROUTPUT">/service</tt> directory you created. 
For a <tt class="COMPUTEROUTPUT">run</tt> script in 
<tt class="COMPUTEROUTPUT">/usr/local/aolserver/servers/server1</tt> use:

</p><pre class="PROGRAMLISTING"> $ ln -s /usr/local/aolserver/servers/server1/ /service</pre><p></p><p>AOLserver should start, if everything went alright.</p></div><div class="SECT2"><h2 class="SECT2"><a name="AEN78">Controlling AOLserver with <tt class="COMPUTEROUTPUT">svc</tt></a></h2><p>Another daemontools program, <tt class="COMPUTEROUTPUT">svc</tt>, is used 
to control AOLserver once it is started. Here is a summary of
the relevent commands:</p><p></p><ul><li><p> <tt class="COMPUTEROUTPUT">svc -d</tt> If the service is running, 
         send it a TERM signal, do not restart.</p></li><li><p> <tt class="COMPUTEROUTPUT">svc -u</tt> If the service is not running, 
         start it. If is stops, restart it.</p></li><li><p> <tt class="COMPUTEROUTPUT">svc -t</tt> Send the service a TERM signal. This allows AOLserver to make an
                   orderly exit. It may take several minutes for a busy server to 
                   exit. Once the server stops, it is immediately restarted.</p></li><li><p> <tt class="COMPUTEROUTPUT">svc -k</tt> Sends the server a KILL signal. 
                   This is like <tt class="COMPUTEROUTPUT">KILL -9</tt>. AOLserver
                   exits immediately. If <tt class="COMPUTEROUTPUT">svc -t</tt> fails to fully kill AOLserver,
                   use this option.</p></li><li><p> <tt class="COMPUTEROUTPUT">svc -o</tt> The server is started. 
                   If it exits, it is not restarted. This might
                   be useful for debugging a startup script. </p></li></ul></div><div class="SECT2"><h2 class="SECT2"><a name="AEN101">Allowing others to restart AOLserver</a></h2><p>If you look again at the directory where <tt class="COMPUTEROUTPUT">run</tt> 
resides, you will see a new 
directory called <tt class="COMPUTEROUTPUT">supervise</tt> . This is the control 
directory. Normally the permissions
do not allow anyone other than the owner of the <tt class="COMPUTEROUTPUT">run</tt> 
script to control the server. However,
<tt class="COMPUTEROUTPUT">svc</tt> will allow a group to also control the server. 
The following script, 
saved as <tt class="COMPUTEROUTPUT">/usr/sbin/svgroup</tt> changes the
permissions to allow group control :</p><pre class="PROGRAMLISTING">#! /bin/sh
if test $# -lt 2 ; then
    echo svgroup groupname directories ... &gt;&amp;2
    echo for example: &gt;&amp;2
    echo svgroup wheel /service/\* &gt;&amp;2
    exit 2
fi
g="$1" ; shift
for i in $* ; do
    chgrp $g $i/supervise/control
    chmod g+w $i/supervise/control
    chgrp $g $i/supervise/ok
    chmod g+w $i/supervise/ok
    # just in case
    chgrp $g $i/supervise/status
    chmod g+r $i/supervise/status
    chgrp $g $i/supervise
    chmod g+x $i/supervise
done </pre><p>For a group <tt class="COMPUTEROUTPUT">web</tt>, and a directory 
<tt class="COMPUTEROUTPUT">/service/server1</tt>, you would run:
</p><pre class="PROGRAMLISTING"> $ /usr/sbin/svgroup web /service/server1</pre><p></p></div><div class="SECT2"><h2 class="SECT2"><a name="AEN114">Startup file for Oracle</a></h2><p>Oracle has a few special requirements. Here is a startup file for AOLserver
using the Oracle <a href="https://web.archive.org/web/20050120114850/http://www.arsdigita.com/acs-repository/" target="_top">driver</a> 
provided by <a href="https://web.archive.org/web/20050120114850/http://www.arsdigita.com/" target="_top">ArsDigita</a>.</p><pre class="PROGRAMLISTING">#!/bin/sh

export ORACLE_HOME="/ora8/m01/app/oracle/product/8.1.6"
export ORACLE_BASE="/ora8/m01/app/oracle"
export LD_LIBRARY_PATH=$ORACLE_HOME/lib:$ORACLE_HOME/ctx/lib:/usr/lib:/lib:/usr/X11R6/lib
export PATH=$ORACLE_HOME/bin:$ORACLE_HOME/ctx/lib:$PATH
export ORACLE_SID='ora8'
export ORACLE_TERM='vt100'
export ORAENV_ASK=NO
export NLS_DATE_FORMAT="YYYY-MM-DD"

exec /home/aol31/bin/nsd -ic /home/aol31/multi.ini -u nsadmin -g web </pre><p>You should adjust any values that may be different for your installation.</p></div><div class="SECT2"><h2 class="SECT2"><a name="APD-ACK">Acknowledgements</a></h2><p>Dan Bernstein's Daemontools Package provides a very stable and secure method of monitoring
and controlling AOLserver. Most of this HOWTO is derived from his literature, or from newsgroups
he has setup to discuss his software.</p></div></div></div>




<!--
     FILE ARCHIVED ON 11:48:50 Jan 20, 2005 AND RETRIEVED FROM THE
     INTERNET ARCHIVE ON 16:37:24 Jul 10, 2016.
     JAVASCRIPT APPENDED BY WAYBACK MACHINE, COPYRIGHT INTERNET ARCHIVE.

     ALL OTHER CONTENT MAY ALSO BE PROTECTED BY COPYRIGHT (17 U.S.C.
     SECTION 108(a)(3)).
-->
</body></html>