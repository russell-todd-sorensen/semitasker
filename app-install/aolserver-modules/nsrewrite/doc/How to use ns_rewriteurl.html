
<!-- saved from url=(0094)https://web.archive.org/web/20050127155703/http://www.zmbh.com/nsrewrite/doc/nsrewriteurl.html -->
<html><!-- $Header$ --><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">


<script type="text/javascript" src="./How to use ns_rewriteurl_files/analytics.js"></script>
<script type="text/javascript">archive_analytics.values.server_name="wwwb-app19.us.archive.org";archive_analytics.values.server_ms=364;</script>
<link type="text/css" rel="stylesheet" href="./How to use ns_rewriteurl_files/banner-styles.css">


 <title>How to use ns_rewriteurl</title>
</head>
<body><div id="wm-ipp" lang="en" style="display: block;">

<div style="position:fixed;left:0;top:0;width:100%!important">
<div id="wm-ipp-inside">
   <table style="width:100%;"><tbody><tr>
   <td id="wm-logo">
       <a href="https://web.archive.org/web/" title="Wayback Machine home page"><img src="./How to use ns_rewriteurl_files/wayback-toolbar-logo.png" alt="Wayback Machine" width="110" height="39" border="0"></a>
   </td>
   <td class="c">
       <table style="margin:0 auto;"><tbody><tr>
       <td class="u" colspan="2">
       <form target="_top" method="get" action="https://web.archive.org/web/form-submit.jsp" name="wmtb" id="wmtb"><input type="text" name="url" id="wmtbURL" value="http://www.zmbh.com/nsrewrite/doc/nsrewriteurl.html" style="width:400px;" onfocus="this.focus();this.select();"><input type="hidden" name="type" value="replay"><input type="hidden" name="date" value="20050127155703"><input type="submit" value="Go"><span id="wm_tb_options" style="display:block;"></span></form>
       </td>
       <td class="n" rowspan="2">
           <table><tbody>
           <!-- NEXT/PREV MONTH NAV AND MONTH INDICATOR -->
           <tr class="m">
           	<td class="b" nowrap="nowrap">
		
		    <a href="https://web.archive.org/web/20041108205811/http://www.zmbh.com/nsrewrite/doc/nsrewriteurl.html" title="8 Nov 2004">NOV</a>
		
		</td>
		<td class="c" id="displayMonthEl" title="You are here: 15:57:03 Jan 27, 2005">JAN</td>
		<td class="f" nowrap="nowrap">
		
		    Feb
		
                </td>
	    </tr>
           <!-- NEXT/PREV CAPTURE NAV AND DAY OF MONTH INDICATOR -->
           <tr class="d">
               <td class="b" nowrap="nowrap">
               
                   <a href="https://web.archive.org/web/20041108205811/http://www.zmbh.com/nsrewrite/doc/nsrewriteurl.html" title="20:58:11 Nov 8, 2004"><img src="./How to use ns_rewriteurl_files/wm_tb_prv_on.png" alt="Previous capture" width="14" height="16" border="0"></a>
               
               </td>
               <td class="c" id="displayDayEl" style="width:34px;font-size:24px;" title="You are here: 15:57:03 Jan 27, 2005">27</td>
	       <td class="f" nowrap="nowrap">
               
                   <img src="./How to use ns_rewriteurl_files/wm_tb_nxt_off.png" alt="Next capture" width="14" height="16" border="0">
               
	       </td>
           </tr>
           <!-- NEXT/PREV YEAR NAV AND YEAR INDICATOR -->
           <tr class="y">
	       <td class="b" nowrap="nowrap">
               
                   2004
               
               </td>
               <td class="c" id="displayYearEl" title="You are here: 15:57:03 Jan 27, 2005">2005</td>
	       <td class="f" nowrap="nowrap">
               
                   2006
               
	       </td>
           </tr>
           </tbody></table>
       </td>
       </tr>
       <tr>
       <td class="s">
           <a class="t" href="https://web.archive.org/web/20050127155703*/http://www.zmbh.com/nsrewrite/doc/nsrewriteurl.html" title="See a list of every capture for this URL">4 captures</a>
           <div class="r" title="Timespan for captures of this URL">30 Jun 04 - 27 Jan 05</div>
       </td>
       <td class="k">
       <a href="https://web.archive.org/web/20050127155703/http://www.zmbh.com/nsrewrite/doc/nsrewriteurl.html" id="wm-graph-anchor">
       <div id="wm-ipp-sparkline" title="Explore captures for this URL">
	 <img id="sparklineImgId" alt="sparklines" onmouseover="__wm.st(1)" onmouseout="__wm.st(0)" onmousemove="__wm.mv(event,this)" width="525" height="27" border="0" src="./How to use ns_rewriteurl_files/graph.jsp">
       <div class="yt" style="display: none; width: 25px; height: 27px;"></div><div class="mt" style="display: none; width: 2px; height: 27px;"></div></div>
       </a>
       </td>
       </tr></tbody></table>
   </td>
   <td class="r">
       <a href="https://web.archive.org/web/20050127155703/http://www.zmbh.com/nsrewrite/doc/nsrewriteurl.html#close" onclick="__wm.h();return false;" style="background-image:url(/static/images/toolbar/wm_tb_close.png);top:5px;" title="Close the toolbar">Close</a>
       <a href="http://faq.web.archive.org/" style="background-image:url(/static/images/toolbar/wm_tb_help.png);bottom:5px;" title="Get some help using the Wayback Machine">Help</a>
   </td>
   </tr></tbody></table>
</div>
</div>
</div>


<!-- BEGIN WAYBACK TOOLBAR INSERT -->
<script type="text/javascript" src="./How to use ns_rewriteurl_files/disclaim-element.js"></script>
<script type="text/javascript" src="./How to use ns_rewriteurl_files/graph-calc.js"></script>
<script type="text/javascript">//<![CDATA[
var __wm = (function(imgWidth,imgHeight,yearImgWidth,monthImgWidth){
var wbPrefix = "/web/";
var wbCurrentUrl = "http://www.zmbh.com/nsrewrite/doc/nsrewriteurl.html";

var firstYear = 1996;
var displayDay = "27";
var displayMonth = "Jan";
var displayYear = "2005";
var prettyMonths = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
var $D=document,$=function(n){return document.getElementById(n)};
var trackerVal,curYear = -1,curMonth = -1;
var yearTracker,monthTracker;
function showTrackers(val) {
  if (val===trackerVal) return;
  var $ipp=$("wm-ipp");
  var $y=$("displayYearEl"),$m=$("displayMonthEl"),$d=$("displayDayEl");
  if (val) {
    $ipp.className="hi";
  } else {
    $ipp.className="";
    $y.innerHTML=displayYear;$m.innerHTML=displayMonth;$d.innerHTML=displayDay;
  }
  yearTracker.style.display=val?"inline":"none";
  monthTracker.style.display=val?"inline":"none";
  trackerVal = val;
}
function trackMouseMove(event,element) {
  var eventX = getEventX(event);
  var elementX = getElementX(element);
  var xOff = Math.min(Math.max(0, eventX - elementX),imgWidth);
  var monthOff = xOff % yearImgWidth;

  var year = Math.floor(xOff / yearImgWidth);
  var monthOfYear = Math.min(11,Math.floor(monthOff / monthImgWidth));
  // 1 extra border pixel at the left edge of the year:
  var month = (year * 12) + monthOfYear;
  var day = monthOff % 2==1?15:1;
  var dateString = zeroPad(year + firstYear) + zeroPad(monthOfYear+1,2) +
    zeroPad(day,2) + "000000";

  $("displayYearEl").innerHTML=year+firstYear;
  $("displayMonthEl").innerHTML=prettyMonths[monthOfYear];
  // looks too jarring when it changes..
  //$("displayDayEl").innerHTML=zeroPad(day,2);
  var url = wbPrefix + dateString + '/' +  wbCurrentUrl;
  $("wm-graph-anchor").href=url;

  if(curYear != year) {
    var yrOff = year * yearImgWidth;
    yearTracker.style.left = yrOff + "px";
    curYear = year;
  }
  if(curMonth != month) {
    var mtOff = year + (month * monthImgWidth) + 1;
    monthTracker.style.left = mtOff + "px";
    curMonth = month;
  }
}
function hideToolbar() {
  $("wm-ipp").style.display="none";
}
function bootstrap() {
  var $spk=$("wm-ipp-sparkline");
  yearTracker=$D.createElement('div');
  yearTracker.className='yt';
  with(yearTracker.style){
    display='none';width=yearImgWidth+"px";height=imgHeight+"px";
  }
  monthTracker=$D.createElement('div');
  monthTracker.className='mt';
  with(monthTracker.style){
    display='none';width=monthImgWidth+"px";height=imgHeight+"px";
  }
  $spk.appendChild(yearTracker);
  $spk.appendChild(monthTracker);

  var $ipp=$("wm-ipp");
  $ipp&&disclaimElement($ipp);
}
return{st:showTrackers,mv:trackMouseMove,h:hideToolbar,bt:bootstrap};
})(525, 27, 25, 2);//]]>
</script>
<style type="text/css">
body {
  margin-top:0 !important;
  padding-top:0 !important;
  min-width:800px !important;
}
</style>

<script type="text/javascript">__wm.bt();</script>
<!-- END WAYBACK TOOLBAR INSERT -->


<h2>Introduction</h2>
<p>The nsrewrite module for AOLserver provides a very simple 
method to change the Request URL during request processing.
</p><p>An HTTP request has the following basic form:
</p><pre>GET /path/to/file/file.adp?x=a HTTP/1.0
Host: www.example.com

</pre>

<p>In this example request, <code>GET</code> is the request Method,
<code>/path/to/file/file.adp</code> is the URL, and <code>x=a</code> is
the querystring. <code>HTTP/1.0</code> identifies the request as being
HTTP version 1.0.

</p><h2>Request Processing in AOLserver</h2>


In AOLserver, each HTTP request passes through a series of steps: 
<ol>
<li>PreAuth Registered Filters</li>
<li>Authentication</li>
<li>PostAuth Registered Filters</li>
<li>Closest Matching Registered Procedure</li>
<li>Trace Registered Filters</li>
</ol>



<h3>Filter Processing in AOLserver</h3>

<p>A filter is composed of a pattern and a procedure. A filter is
added to one of the three lists of filters (PreAuth, PostAuth, Trace) 
by calling <code>ns_register_filter</code> from tcl as follows:

</p><pre>ns_register_filter preauth GET /a/b/*.html myHtmlProc
ns_register_filter preauth GET /a* myEverythingProc
ns_register_filter postauth GET /a/one.html myOneProc
</pre>

<p>When AOLserver processes a request through a set of filters, each filter 
is tried in the order it was registered. If the Request URL matches the 
pattern in the filter, the filter procedure is run. When the procedure finishes,
the next filter pattern is tried for a match to the Request URL.

</p><p>In the above list of registered filters, a <code>GET</code> request for the 
url <code>/a/b/c.html</code> would match the first two filters, but not the 
third filter. A <code>POST</code>, or <code>HEAD</code> request on the same
url would not match any of the filters.

</p><h3>Rewriting the Request URL</h3>

<p>The above discussion assumed that the Request URL remained the same 
throughout the lifetime of the request. However, the filter matching process is
performed in series with the filter procedure that is run. If the filter
procedure were to change the Request URL, the next filter pattern in the series
would be compared to the new Request URL.

</p><p>The <code>nsrewrite</code> module for AOLserver provides a convenient means 
to modify the Request URL. The use of this procedure within a filter 
allows for some interesting possibilities.

</p><h3>A simple virtual hosting module</h3>

<p>Following is an example use of the <code>nsrewrite</code> module to provide
virtual hosting inside a single AOLserver.

</p><p>The <code>nsrewrite</code> module provides a single tcl procedure to set the
Request URL:

</p><pre>ns_rewriteurl $new_url
</pre>

<p>Once this procedure is called, the procedure <code>[ns_conn url]</code> will 
return the value of <code>$new_url</code>.  If the Request URL value was used 
only at the start of a request, or if the filter matching was done with a 
copy of the Request URL, this procedure would be of no other value.
However, the new Request URL is used for any additional filter matching and for
Registered Procedure matching in step 4 above.

</p><p>Consider the filter procedure:

</p><pre>proc rewriteRequest { why } {

    set url [ns_conn url]
    ns_log Notice "rewriteRequest: starturl: '$url'"

    set host [string tolower [ns_set iget [ns_conn headers] host]] 
    
    if {![string match "" $host]} {
	set new_url "/${host}$url"
	ns_rewriteurl $new_url
	ns_log Notice "rewriteRequest: newurl: '$new_url'"
    } 
    return filter_ok
}

</pre>

<p><code>rewriteRequest</code> prepends the value of the request <code>Host:</code> 
header to the URL so that the request detailed above in the Introduction could 
result in the following:

</p><pre>ns_rewriteurl /www.example.com/path/to/file/file.adp
</pre>

<p>I say could, because we need to register the filter correctly:

</p><pre># Fire rewriteRequest on every request
ns_register_filter preauth GET /* rewriteRequest
</pre>

<p>Now that we prepend the host header to the original URL, we need to
clean up the problem of users typing 'www.' in front of the host name.

</p><p>Since filter pattern matching is just like 
<code>[string match $pattern $url]</code>, we can write a procedure,
and corresponding registered filter to handle this case:

</p><pre>proc rewriteWWW { why } {

    set new_url "/[string range [ns_conn url] 5 end]"
    ns_log Notice "rewriteWWW: url: '[ns_conn url]' newurl: '$new_url'"
    ns_rewriteurl $new_url
    return filter_ok
}

# rewrite URLs beginning with www:
ns_register_filter preauth GET /www.* rewriteWWW

</pre>

<p>This would cause the following call to <code>ns_rewriteurl</code>
</p><pre>ns_rewriteurl /example.com/path/to/file/file.adp
</pre>

<p>Since this is the last PreAuth filter (in this example), AOLserver
authorization will now take place on the new URL 
<code>/example.com/path/to/file/file.adp</code>

</p><p>Passing the authorization stage, AOLserver will process all PostAuth
filters. ( PreAuth and PostAuth filtering is stopped if any PreAuth filter
returns <code>filter_return</code>, or any PostAuth filter returns
<code>filter_return</code> or <code>filter_break</code>. ) 

</p><p>If all PreAuth
and PostAuth filters finish and none of them have returned 
<code>filter_return</code>, the Registered Procedures are examined to 
determine if there is a match. At most one Registered Procedure will match.
AOLserver uses a data structure know as a <code>Trie</code> to store and locate
the Registered Procedure with the closest match to the Request URL. 
Registered Procedure matching is different than matching with Registered 
Filters. Only the ending of the URL pattern is allowed to have a glob
characters. However, matching can be inherited below the URL pattern 
specified. By default, the fastpath procs are registered at server startup
for all URLs and the <code>GET</code>, <code>POST</code> and <code>HEAD</code>
methods (in C, from nsd/fastpath.c):
 
</p><pre>/* server, Method, URL, Procedure, DeleteProc, userContext, Flags */
Ns_RegisterRequest(server, "GET", "/", FastGet, NULL, NULL, 0);
Ns_RegisterRequest(server, "HEAD", "/", FastGet, NULL, NULL, 0);
Ns_RegisterRequest(server, "POST", "/", FastGet, NULL, NULL, 0);
</pre>

<p>In our example virtual host server, all requests will end up being served
by the <code>FastGet</code> function, which makes this virtual server...fast!

</p><p>Finally, any trace filters will be run, regardless of any return codes from
previous Registered Filters of Registered Procedures.

</p><p>Here is a filter which will log the final Request URL:

</p><pre>proc finalURL { why } {

    ns_log Notice "finalURL: URL: '[ns_conn url]'"
    return filter_ok
}

# show final URL in trace filter
ns_register_filter trace GET /* finalURL

</pre>

<h2>Virtual Hosting Module</h2>

<p>Below is a copy of the simple virtual hosting module described above:

</p><pre>#
# The contents of this file are subject to the AOLserver Public License
# Version 1.1 (the "License"); you may not use this file except in
# compliance with the License. You may obtain a copy of the License at
# http://aolserver.com/.
#
# Software distributed under the License is distributed on an "AS IS"
# basis, WITHOUT WARRANTY OF ANY KIND, either express or implied. See
# the License for the specific language governing rights and limitations
# under the License.
#
# The Original Code is AOLserver Code and related documentation
# distributed by AOL.
# 
# The Initial Developer of the Original Code is America Online,
# Inc. Portions created by AOL are Copyright (C) 1999 America Online,
# Inc. All Rights Reserved.
#
# Alternatively, the contents of this file may be used under the terms
# of the GNU General Public License (the "GPL"), in which case the
# provisions of GPL are applicable instead of those above.  If you wish
# to allow use of your version of this file only under the terms of the
# GPL and not to allow others to use your version of this file under the
# License, indicate your decision by deleting the provisions above and
# replace them with the notice and other provisions required by the GPL.
# If you do not delete the provisions above, a recipient may use your
# version of this file under either the License or the GPL.
#

#
# $Header$
#
#
# rewriteurl.tcl -- Demonstrate use of ns_rewriteurl
#

ns_log Notice "tcl/rewriteurl.tcl: loading test rewrite filters..."

# rewriteRequest prepends the host header to the URL
# http://example.com/some/url.html -&gt; /example.com/some/url.html

# to test:
# echo "127.0.0.1 example.com www.example.com" &gt;&gt; /etc/hosts
# run aolserver on 127.0.0.1:80
# create a test file in $pageroot/example.com/
# visit http://example.com/test.file or http://www.example.com/test.file

proc rewriteRequest { why } {

    set url [ns_conn url]
    ns_log Notice "rewriteRequest: starturl: '$url'"

    set host [string tolower [ns_set iget [ns_conn headers] host]] 
    
    if {![string match "" $host]} {
	set new_url "/${host}$url"
	ns_rewriteurl $new_url
	ns_log Notice "rewriteRequest: newurl: '$new_url'"
    } 
    return filter_ok
}


proc finalURL { why } {

    ns_log Notice "finalURL: URL: '[ns_conn url]'"
    return filter_ok
}

proc rewriteWWW { why } {

    set new_url "/[string range [ns_conn url] 5 end]"
    ns_log Notice "rewriteWWW: URL: '[ns_conn url]' newurl: '$new_url'"
    ns_rewriteurl $new_url
    return filter_ok
}


# Fire rewriteRequest on every request
ns_register_filter preauth GET /* rewriteRequest

# rewrite URLs beginning with www:
ns_register_filter preauth GET /www.* rewriteWWW

# show final URL in trace filter
ns_register_filter trace GET /* finalURL


ns_log Notice "tcl/rewriteurl.tcl: finished loading test rewrite filters."

</pre>








<!--
     FILE ARCHIVED ON 15:57:03 Jan 27, 2005 AND RETRIEVED FROM THE
     INTERNET ARCHIVE ON 16:25:36 Jul 10, 2016.
     JAVASCRIPT APPENDED BY WAYBACK MACHINE, COPYRIGHT INTERNET ARCHIVE.

     ALL OTHER CONTENT MAY ALSO BE PROTECTED BY COPYRIGHT (17 U.S.C.
     SECTION 108(a)(3)).
-->
</body></html>