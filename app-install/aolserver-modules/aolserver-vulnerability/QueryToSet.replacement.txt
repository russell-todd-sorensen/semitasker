/*
 * QueryToSet replacement from nsd/conn.c in AOLserver version 3.4.2
 * Note: I don't know if this works for encodings other than the default.
 * However, maybe ns_queryget also will have a problem since it creates 
 * a variable by appending .tmpfile to the filename variable.
 */
static int
QueryToSet(char *query, Ns_Set *set, void *enc)
{
    char           *name;
    char           *value;
    int             done, status;
    int             index;
    Ns_DString      ds;
    char           *decode;
    Tcl_DString	    tds;

    status = NS_OK;
    Tcl_DStringInit(&tds);
    Ns_DStringInit(&ds);
    name = query;
    done = 0;
    for (;;) {
        switch (*query) {
	    case '\n':
	    case '\r':
	    case '\0':
                done = 1;
                /* FALLTHROUGH */

	    case '&':
                *query = '\0';
                value = strchr(name, '=');
                if (value != NULL) {
                  *value = '\0';
                }
                decode = Decode(&ds, &tds, enc, name);
                if (decode == NULL) {
                    status = NS_ERROR;
                    goto done;
                }
                // name cannot end in .tmpfile
                if (strstr(decode, ".tmpfile")) {
                    Ns_Log(Error,"querystring variable contains .tmpfile");
                    status = NS_ERROR;
                    goto done;
                }
                index = Ns_SetPut(set, decode, NULL);
                if (value != NULL) {
                    *value++ = '=';
		    decode = Decode(&ds, &tds, enc, value);
		    if (decode == NULL) {
			status = NS_ERROR;
			goto done;
		    }
		    Ns_SetPutValue(set, index, decode);
		}
		if (done) {
		    goto done;
		}
		++query;
		name = query;
		break;

	    case '+':
		*query = ' ';
		/* FALLTHROUGH */

	    default:
		++query;
		break;
        }
    }

 done:
    Ns_DStringFree(&ds);
    Tcl_DStringFree(&tds);
    return status;
}
