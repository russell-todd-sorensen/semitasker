/*
 *  Replaces ParseQuery in nsd/form.c version 1.9 AOLserver 4.0
 *  Note: since ParseQuery returns void, error cannot be returned
 *  to caller.
 */

static void
ParseQuery(char *form, Ns_Set *set, Tcl_Encoding encoding)
{
    char *p, *k, *v;
    Tcl_DString      kds, vds;

    Tcl_DStringInit(&kds);
    Tcl_DStringInit(&vds);
    p = form;
    while (p != NULL) {
        k = p;
        p = strchr(p, '&');
        if (p != NULL) {
            *p++ = '\0';
        }
        v = strchr(k, '=');
        if (v != NULL) {
            *v = '\0';
        }
        k = Decode(&kds, k, encoding);
        if (v != NULL) {
            Decode(&vds, v+1, encoding);
            *v = '=';
            v = vds.string;
        }
        // if blocks attempt to read arbitrary file on server.
        if (strstr(k, ".tmpfile")) {
            Ns_Log(Error,"querystring variable contains .tmpfile");
            Tcl_DStringFree(&kds);
            Tcl_DStringFree(&vds);
            return;
        }
        Ns_SetPut(set, k, v);
    }
    Tcl_DStringFree(&kds);
    Tcl_DStringFree(&vds);
}
