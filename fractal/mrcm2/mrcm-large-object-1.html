<!DOCTYPE html>
<html lang="en-US">
<head>
<meta charset="utf-8">

<title>Multiple Reduction Copy Machine using Affine Transforms</title>
<style>

body,html {
  font-family:"Lucida Console", Monaco, monospace;
  background-color: white;
  margin:0;
  padding:0;
  border:0;
}

#composite {
    position: relative;
    width: 80%;
}
#svg {
    margin: 15px;
}
#svg2 {
    position: absolute;
    top: 15.5px;
    left: 30.5px;
}

#main, #main2 {
    position: relative;
    border: 3px solid black;
    display: inline-block;
}

#myCanvas, #myCanvas2 {
    border: 1px solid #444;
    margin-top: 15px;
    margin-left: 30px;
    background-clip:padding-box;
    background-color: black;
}

#box, #box2 {
    position: absolute;
    top: 0;
    right: 0;
    background-color: rgba(255,0,0,.1);
    border: 1px solid black;
}

#controls {
    font-family: "Consolas Bold";
    color: white;
    background-color: #444;
    position: absolute;
    right: 0;
    top: 0;
    display: none;
}

#controls-2 {
    font-family: "Fira Code VF";
    color: white;
    background-color: #444;
    display: inline-block;
    vertical-align: top;
    margin: 16px;
}

#colors {
    border: 2px solid #555;
    position: absolute;
    right: 285px;
    top: 3px;
}

#controls ul,
#controls-2 ul {
    font-family: inherit;
    list-style: none;
    padding: 0;
}


#controls input, 
#controls-2 input,
#controls select, 
#controls-2 select {
    display: inline-block;
    font-family: "Tw Cen MT Bold";
    font-size: 15px;
    width: 162px;
    margin-left: 12px;
}

#controls input[type=range],
#controls-2 input[type=range] {
    width: 200px;
}

/* this is how you change the font of select options!!! */
#theory { /* select id */
    font-family: "Tw Cen MT Bold";
    font-size: 16px;
}

#mode-controls {
    letter-spacing: 1px;
}

#controls input[type=number] {
    width: 60px;
}

#controls #pixelJump input[type=number],
#controls-2 #pixelJump input[type=number] {
    width: 50px;
}

#controls select,
#controls-2 select {
    width: 100px;
}

#hide {
    display: none;
}
circle {
    fill: inherit;
}
</style>
<script>

var M = new Array();
var Points = new Array();
var w = 600;
var h = 600;
var left = 30;
var w1 = w + left;
var numPoints = 100000;
</script>

<script src="https://ajax.googleapis.com/ajax/libs/d3js/3.5.17/d3.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script src="/js/log-2.js"></script>
<script src="js/matrix2.js" charset="utf-8"></script>
<script src="js/mrcm-affine.js" charset="utf-8"></script>
<script src="js/matrix-math.js" charset="utf-8"></script>
<script>

function applyMatrix(groupId,href,matrix) {
    let svg = d3.select("#svg"),
        compGroup = d3.select("#composition-table")
        show = svg.select("#show"),
        group = svg.select(`#${groupId}`);

    group.append("use")
        .attr("href",href)
        .attr("transform",matrix.toMatrix())
        .attr("opacity",matrix.pct);

    show.attr("href",`#${groupId}`);
}

function groupAppend(group,href,matrix) {
    group.append("use")
        .attr("href",href)
        .attr("transform",matrix.toMatrix());
}

function applyAllMatrices(href,matrix) {
    let len = matrix.length,
        svg = d3.select("#svg"),
        show = svg.select("#show"),
        defs = svg.select("defs"),
        lastGid = `g${subGroups.length}`;
    if (subGroups.length) {
        href = `#g${subGroups.length-1}`;
    }
    subGroups.push(href);
    defs.append("g")
        .attr("id",lastGid);
    let group = defs.select(`#${lastGid}`);
    show.attr("href",`#${lastGid}`);

    for (let i=0;i<len;i++) {
        groupAppend(group,href,matrix[i]);
    }
    for (let i=0;i<len;i++) {
        groupAppend(group,"#invariant",matrix[i]);
    }

}
var subGroups = [];
/////////// NOTE /////////////
///Zeroing out the CM array to use indexes == labels
CM=[];

CM.push(  // Matrix 0: d0 (AKA: neutral element e)
    new MRCM(640,640,CM.length,`Matrix ${CM.length}: Symmetry Transformations of the Square (d0)`,
        {a:1,b:0,c:0,d:1,e:0,f:0,pct:1.0000},  // V1(x,y) = (x,y)
    )
);
CM.push(  // Matrix 1: d1 (rotate 90deg clockwise) 
    new MRCM(640,640,CM.length,`Matrix ${CM.length}: Symmetry Transformations of the Square (d1)`,
       // {a:1,b:-1,c:-1,d:1,e:1,f:0,pct:1.0000},  // V1(x,y) = (y,x)
       {a:0,b:1,c:-1,d:0,e:1,f:0,pct:1.0000},  
    )
);
CM.push(  // Matrix 2: d2 (rotate 180deg clockwise)
    new MRCM(640,640,CM.length,`Matrix ${CM.length}: Symmetry Transformations of the Square (d2)`,
        {a:-1,b:0,c:0,d:-1,e:1,f:1,pct:1.0000},  // V1(x,y) = (1-x,1-y)
    )
);
CM.push(  // Matrix 3: d3 (rotate 270deg clockwise) d1^3
    new MRCM(640,640,CM.length,`Matrix ${CM.length}: Symmetry Transformations of the Square (d3)`,
        {a:0,b:-1,c:1,d:0,e:0,f:1,pct:1.0000},  // V1(x,y) = (y,x)
    )
);
CM.push(  // Matrix 4: d4 (Horizontal Mirror)
    new MRCM(640,640,CM.length,`Matrix ${CM.length}: Symmetry Transformations of the Square (d4)`,
        {a:1,b:0,c:0,d:-1,e:0,f:1,pct:1.0000},  // V1(x,y) = (x,1-y)
    )
);
CM.push(  // Matrix 5: d5 (Vertical Mirror) = (d1^2)*d4
    new MRCM(640,640,CM.length,`Matrix ${CM.length}: Symmetry Transformations of the Square (d5)`,
        {a:-1,b:0,c:0,d:1,e:1,f:0,pct:1.0000},  // V1(x,y) = (1-x,y)
    )
);
CM.push(  // Matrix 6: d6 (Mirror Around +45deg diagonal ( \ ) )
    new MRCM(640,640,CM.length,`Matrix ${CM.length}: Symmetry Transformations of the Square (d6)`,
        {a:0,b:1,c:1,d:0,e:0,f:0,pct:1.0000},  // V1(x,y) = (y,x)
    )
);
CM.push(  // Matrix 7: d7 (Mirror Around -45deg diagonal ( / )) (d1^3)*d4
    new MRCM(640,640,CM.length,`Matrix ${CM.length}: Symmetry Transformations of the Square (d7)`,
        {a:0,b:-1,c:-1,d:0,e:1,f:1,pct:1.0000},  // V1(x,y) = (y,x)
    )
);

//////////// END OF BASIC TRANSFORMATIONS ON UNIT SQUARE ///////////////////

CM.push(  // Matrix 8: xx (Horizontal Mirror) 
    new MRCM(640,640,CM.length,`Matrix ${CM.length}: Symmetry Transformations of the Square (xx)`,
        {a:1,b:1,c:1,d:-1,e:0,f:0,pct:1.0000},  // V1(x,y) = (y,x)
    )
);
CM.push(  // Matrix 8: Squares1
    new MRCM(640,640,CM.length,`Matrix ${CM.length}: Squares1`,
        {a:.5,b:0,c:0,d:.5,e:0,f:.5,pct:.333333},
        {a:.5,b:0,c:0,d:.5,e:0,f:0,pct:.333333},
        {a:.5,b:0,c:0,d:.5,e:.5,f:.5,pct:.333334},
    )
);
CM.push(  // Matrix 10: Squares2
    new MRCM(640,640,CM.length,`Matrix ${CM.length}: Squares2`,
        {a:.5,b:0,c:0,d:.5,e:0,f:0,pct:.333333},  // V1(x,y) = (x/2,y/2)
        {a:.5,b:0,c:0,d:.5,e:.5,f:0,pct:.333334}, // V2(x,y) = ((x+1)/2,y/2)
        {a:.5,b:0,c:0,d:.5,e:0,f:.5,pct:.333333}, // V3(x,y) = (x/2,(y+1)/2)
    )
);

CM.push(  // Matrix 11: Squares3
    new MRCM(640,640,CM.length,`Matrix ${CM.length}: Squares3`,
        {a:.5,b:0,c:0,d:.5,e:0,f:.5,pct:.333333},
        {a:.5,b:0,c:0,d:.5,e:.25,f:0,pct:.333333},
        {a:.5,b:0,c:0,d:.5,e:.5,f:.5,pct:.333334},
    )
);
CM.push( // Matrix 12: Sierpinski Carpet
    new MRCM(640,640,CM.length,`Matrix ${CM.length}: Sierpinski Carpet`,
     {a:1/3,b:0,c:0,d:1/3,e:0,f:0,pct:1/8},
     {a:1/3,b:0,c:0,d:1/3,e:1/3,f:0,pct:1/8},
     {a:1/3,b:0,c:0,d:1/3,e:2/3,f:0,pct:1/8},
     {a:1/3,b:0,c:0,d:1/3,e:0,f:1/3,pct:1/8},
     {a:1/3,b:0,c:0,d:1/3,e:2/3,f:1/3,pct:1/8},
     {a:1/3,b:0,c:0,d:1/3,e:0,f:2/3,pct:1/8},
     {a:1/3,b:0,c:0,d:1/3,e:1/3,f:2/3,pct:1/8},
     {a:1/3,b:0,c:0,d:1/3,e:2/3,f:2/3,pct:1/8},
    )
);

CM.push(
    new MRCM(640,640,CM.length,`Matrix ${CM.length}: SG2`,
        {a:0,b:-0.5,c:.5,d:0,e:.5,f:0.5,pct:1/3},
        {a:0,b:0.5,c:-.5,d:0,e:.5,f:0,pct:1/3},
        {a:.5,b:0,c:0,d:.5,e:.25,f:0.5,pct:1/3},
    )
);

CM.push( // Matrix 13: 
    new MRCM(640,640,CM.length,`Matrix ${CM.length}: Fractal Blob 2`,
        {a:0,b:-.577,c:.577,d:0,e:.0951,f:.5893,pct:1/3},
        {a:0,b:-.577,c:.577,d:0,e:.4413,f:.7893,pct:1/3},
        {a:0,b:-.577,c:.577,d:0,e:.0952,f:.9893,pct:1/3},
    )
);

CM.push( // Matrix 14: 
    new MRCM(640,640,CM.length,`Matrix ${CM.length}: Cantor Maze 2`,
        {a:1/3,b:0,c:0,d:1/3,e:1/3,f:2/3,pct:.2},
        {a:0,b:1,c:-1/3,d:0,e:1/3,f:0,pct:.4},
        {a:0,b:1,c:1/3,d:0,e:2/3,f:0,pct:.4},
    )
);

CM.push( // Matrix 15: 
    new MRCM(640,640,CM.length,`Matrix ${CM.length}: Twig`,
    {a:.387,b:.430,c:.430,d:-.387,e:.2560,f:.522,pct:.333},
    {a:0.441,b:-.091,c:-.009,d:-.322,e:.4219,f:.5059,pct:.333},
    {a:-.468,b:.020,c:-.113,d:.015,e:.4,f:.4,pct:.334},
    )
);

CM.push( // Matrix 16: 
    new MRCM(640,640,CM.length,`Matrix ${CM.length}: Snowflake`,
    {a:0.255,b:0,c:0,d:.255,e:.3726,f:.6714,pct:.16},
    {a:0.255,b:0,c:0,d:.255,e:.1146,f:.2232,pct:.16},
    {a:0.255,b:0,c:0,d:.255,e:.6306,f:.2232,pct:.16},
    {a:0.37,b:.642,c:-.642,d:.37,e:.6356,f:-.0061,pct:.52},
    )
);

CM.push( // Matrix 17: 
    new MRCM(640,640,CM.length,`Matrix ${CM.length}: Pentagons`,
        {a:0.382,b:0,c:0,d:.382,e:.3072,f:.619,pct:.2},
        {a:0.382,b:0,c:0,d:.382,e:.6033,f:.4044,pct:.2},
        {a:0.382,b:0,c:0,d:.382,e:.0139,f:.4044,pct:.2},
        {a:0.382,b:0,c:0,d:.382,e:.1253,f:.0595,pct:.2},
        {a:0.382,b:0,c:0,d:.382,e:.4920,f:.0595,pct:.2},
    )
);
/*
CM.push( // Matrix 18: 
    new MRCM(640,640,CM.length,`Matrix ${CM.length}: Tree`,
        {a:0.195,b:-.488,c:.344,d:.443,e:.4431,f:.2452,pct:.2},
        {a:0.462,b:.414,c:-.252,d:.361,e:.2511,f:.5692,pct:.2},
        {a:-.058,b:-.07,c:.453,d:-.111,e:.5976,f:.0969,pct:.2},
        {a:-.035,b:.07,c:-.469,d:-.022,e:.4884,f:.5069,pct:.2},
        {a:-.637,b:0,c:0,d:.501,e:.8562,f:.2513,pct:.2},
    )
);

CM.push( // Matrix 18: 
    new MRCM(640,640,CM.length,`Matrix ${CM.length}: Tree`,
        {a:-.4880,b:.195,c:.443,d:.344,e:.2452,f:.4431,pct:.2},
        {a:0.462,b:-.414,c:.252,d:.361,e:.2511,f:.5692,pct:.2}, //1
        //{a:-.058,b:-.07,c:.453,d:-.111,e:.5976,f:.0969,pct:.2},
        //{a:-.035,b:.07,c:-.469,d:-.022,e:.4884,f:.5069,pct:.2},
        {a:-.637,b:0,c:0,d:.501,e:.8562,f:.2513,pct:.2},
    )
);*/

CM.push( // Matrix 19: 
    new MRCM(360,640,CM.length,`Matrix ${CM.length}: Leaf2`,
      {a:0.849,b:.037,c:-.037,d:.849,e:.075,f:.183,pct:.70},
        {a:0.197,b:.226,c:-.226,d:.197,e:.4,f:.049,pct:.13},
       {a:-0.15,b:.283,c:.26,d:.237,e:.575,f:-.084,pct:.13},
        {a:0.03,b:0,c:.01,d:.16,e:.5,f:0,pct:.04},
    )
);

CM.push( // Matrix .16: Sierpinski Carpet 4
    new MRCM(640,640,CM.length,`Matrix ${CM.length}: Sierpinski Carpet 4`,
     {a:0,b:1/4,c:-1/4,d:0,e:1/3,f:0,pct:1/8},
     {a:1/3,b:0,c:0,d:1/3,e:1/3,f:0,pct:1/8},
     {a:1/3,b:0,c:0,d:1/3,e:2/3,f:0,pct:1/8},
     {a:1/3,b:0,c:0,d:1/3,e:0,f:1/3,pct:1/8},
     {a:1/3,b:0,c:0,d:1/3,e:2/3,f:1/3,pct:1/8},
     {a:1/3,b:0,c:0,d:1/3,e:0,f:2/3,pct:1/8},
     {a:1/3,b:0,c:0,d:1/3,e:1/3,f:2/3,pct:1/8},
     {a:1/3,b:0,c:0,d:1/3,e:2/3,f:2/3,pct:1/8},
    )
);
//{a:0,b:1,c:-1,d:0,e:1,f:0,pct:1.0000}
//{a:1/3,b:0,c:0,d:1/3,e:0,f:0,pct:1/8},
CM.push( // Matrix .17: Sierpinski Carpet 5
    new MRCM(640,640,CM.length,`Matrix ${CM.length}: Sierpinski Carpet 5`,
        {a:1/3,b:0,c:0,d:1/3,e:0,f:0,pct:1/8},
       // {a:0,b:1/4,c:-1/4,d:0,e:1/4,f:0,pct:1/8},
        {a:1/3,b:0,c:0,d:1/3,e:1/3,f:0,pct:1/8},
        {a:1/3,b:0,c:0,d:1/3,e:2/3,f:0,pct:1/8},
        {a:1/3,b:0,c:0,d:1/3,e:0,f:1/3,pct:1/8},
        {a:1/3,b:0,c:0,d:1/3,e:2/3,f:1/3,pct:1/8},
       // {a:1/3,b:0,c:0,d:1/3,e:0,f:2/3,pct:1/8},
        {a:1/3,b:0,c:0,d:1/3,e:1/3,f:2/3,pct:1/8},
      //  {a:1/3,b:0,c:0,d:1/3,e:2/3,f:2/3,pct:1/8},
    )
);
//{a:0,b:1,c:-1,d:0,e:1,f:0,pct:1.0000}
CM.push( // Matrix .18: Sierpinski Carpet 4
    new MRCM(640,640,CM.length,`Matrix ${CM.length}: Sierpinski Carpet 6`,
     //{a:0,b:1/4,c:-1/4,d:0,e:-1/5,f:-1/5,pct:1/8},
     {a:1/3,b:0,c:0,d:1/3,e:1/3,f:0,pct:1/8},
     {a:1/3,b:0,c:0,d:1/3,e:2/3,f:0,pct:1/8},
     {a:1/3,b:0,c:0,d:1/3,e:0,f:1/3,pct:1/8},
     {a:1/3,b:0,c:0,d:1/3,e:2/3,f:1/3,pct:1/8},
     {a:1/3,b:0,c:0,d:1/3,e:0,f:2/3,pct:1/8},
     {a:1/3,b:0,c:0,d:1/3,e:1/3,f:2/3,pct:1/8},
     {a:1/3,b:0,c:0,d:1/3,e:2/3,f:2/3,pct:1/8},
    )
);
//{a:0,b:1,c:-1,d:0,e:1,f:0,pct:1.0000}
//{a:1/3,b:0,c:0,d:1/3,e:0,f:0,pct:1/8},
CM.push( // Matrix .19: Sierpinski Carpet 4
    new MRCM(640,640,CM.length,`Matrix ${CM.length}: Sierpinski Carpet 7`,
    {a:0,b:1/3,c:-1/3,d:0,e:1/3,f:0,pct:1/8},
   //  {a:0,b:-1/4,c:1/4,d:0,e:-1/4,f:0,pct:1/8},
     {a:1/3,b:0,c:0,d:1/3,e:1/3,f:0,pct:1/8},
     {a:1/3,b:0,c:0,d:1/3,e:2/3,f:0,pct:1/8},
     {a:1/3,b:0,c:0,d:1/3,e:0,f:1/3,pct:1/8},
     {a:1/3,b:0,c:0,d:1/3,e:2/3,f:1/3,pct:1/8},
     {a:1/3,b:0,c:0,d:1/3,e:0,f:2/3,pct:1/8},
     {a:1/3,b:0,c:0,d:1/3,e:1/3,f:2/3,pct:1/8},
     {a:1/3,b:0,c:0,d:1/3,e:2/3,f:2/3,pct:1/8},
    )
);
//{a:0,b:1,c:-1,d:0,e:1,f:0,pct:1.0000}
//{a:1/3,b:0,c:0,d:1/3,e:0,f:0,pct:1/8},
CM.push(
    new MRCM(640,640,CM.length,`Matrix ${CM.length}: AHT 1`,
    {a:0,b:-.5,c:.5,d:0,e:0,f:.5},
    {a:.5,b:0,c:0,d:.5,e:.25,f:.25},
    {a:.5,b:0,c:0,d:.5,e:.5,f:0},
    {a:0,b:.5,c:-.5,d:0,e:1,f:.5},
    )
);
CM.push(
    new MRCM(640,640,CM.length,`Matrix ${CM.length}: AHT 2`,
    {a:0,b:.5,c:-.5,d:0,e:.5,f:0},
    {a:.5,b:0,c:0,d:.5,e:0,f:.25},
    {a:.5,b:0,c:0,d:.5,e:.25,f:.25},
    {a:0,b:.5,c:-.5,d:0,e:.5,f:.75},
    )
);

function abcdByAngle(angle,scale,offsetX,offsetY) {
    angle = angle?angle:0;
    scale = scale?scale:1;
    offsetX=offsetX?offsetX:0;
    offsetY=offsetY?offsetY:0;

    let cos = Math.cos(angle),
        sin = Math.sin(angle);

    cos = (Math.abs(cos) < 1000*Number.EPSILON)?0:cos;
    sin = (Math.abs(sin) < 1000*Number.EPSILON)?0:sin;

    return {
        a:scale*cos,
        b:scale*-sin,
        c:scale*sin,
        d:scale*cos,
        e:offsetX,
        f:offsetY
    };
}

CM.push(
    new MRCM(640,640,CM.length,`Matrix ${CM.length}: AHT 4`,
        abcdByAngle(Math.PI,.5,.75,0.3142), // rotate 180,scale .5
        abcdByAngle(0,.5,.25,0.25), // rotate   0,scale .5
        abcdByAngle(2*Math.PI/3,.5,.785,.625), // rotate 120,scale .5 .783 .628318
        abcdByAngle(-2*Math.PI/3,.5,.467125,.1925), // rotate -120,scale .5
    )
);

CM.push(
    new MRCM(640,640,CM.length,`Matrix ${CM.length}: AHT 4`,
        abcdByAngle(Math.PI,.5,.75,0.21660635094610968), // rotate 180,scale .5 offsetY=0.21650635094610968
        abcdByAngle(0,.5,0.25,0.21650635094610968), // rotate   0,scale .5 offsetY=0.21650635094610968
        abcdByAngle(2*Math.PI/3,.5,.8125,.541400), // rotate 120,scale .5 .783 .628318 1*0.8660254037844387
        abcdByAngle(-2*Math.PI/3,.5,0.4375,.1083), // rotate -120,scale .5 .25*.541525
    )
);














CM.push(
    new MRCM(640,640-2*4.2871870789,CM.length,`Matrix ${CM.length}: AHT 5 (mod)`,
        abcdByAngle(0,.5,.25,0), // rotate   0,scale .5 trans 1/4
        abcdByAngle(Math.PI,.5,.75,.5),
        abcdByAngle(4*Math.PI/3,.5,1.0,(0.75*4.2871870789/64)),
        //+ (4.2871870789/64)
      //  abcdByAngle(Math.PI,.5,.75,0.3175), // rotate 180,scale .5
       // abcdByAngle(2*Math.PI/3,.5,.783,.625), // rotate 120,scale .5
      //  abcdByAngle(4*Math.PI/3,.5,.467125,.1925), // rotate +240,scale .5
    )
);


</script>

</head>
<body>
<div id="no-hide">
 <svg id="svg" x="-128" y="-128" height="896" width="896" viewBox="-128 -128 896 896">
<defs>
<style>
#svg {
    border:1px dashed tan;
}
#svg text {
    font-size: 150px;
    fill: black;
    font-family: 'Lucida Sans', 'Lucida Sans Regular', 'Lucida Grande', 'Lucida Sans Unicode', Geneva, Verdana, sans-serif;
    font-weight: bold;
}
#gr1 rect {
    stroke: purple;
    stroke-width: 2;
    fill: transparent;
}
.r0 {
    fill: rgba(0,0,0,.1);
}
#r2 {
    fill: rgba(0,0,0,.8);
    stroke: rgb(220, 223, 44);
    stroke-width: 0.05px;
}

#r3 {
    fill: white;
    stroke: rgb(21, 247, 198);
    stroke-width: 0.05px;
}

#r6 {
    fill: rgba(156, 144, 144,.6);
    stroke: rgba(14, 160, 80,.6);
    stroke-width: 0.05px;
}

#r5 {
    fill: rgba(134, 7, 7, 0.8);
    stroke: rgb(220, 223, 44);
    stroke-width: 0.5px;  /**/
}

#svg .aht1 {
    fill: rgba(134, 7, 7, 0.8);
  /*  stroke: rgb(220, 223, 44);
    stroke-width: 0.5px; */
}
#r4 {
    fill: rgba(0,0,0,1);
}
#c0 {
    stroke: black;
    fill: transparent;
    stroke-width: .125px;
}
#c0 {
    stroke: black;
    fill: rgba(0,0,255,.1);
    stroke-width: .125px;
}
#dashed-pos-boundary {
    stroke-width: 1;
    stroke-dasharray: 5 2; 
    stroke: tan;
    fill: none;
}
#dim-past-boundary {
    fill: rgba(255,255,255,.8);
    stroke-width:0;
}
#path-aht10 {
    stroke: rgba(0,0,0,1);
    stroke-width: 0.50;
    fill: rgba(204,48,84,.9);
}
.align-1 {
    stroke: black;
    stroke-width: 2;
}
.align-2 {
    stroke: white;
    stroke-width: .5;
}

#alignment-2 .align-1 {
    stroke: rgba(0,0,0,.6);
    stroke-width: .5;
}
#alignment-2 .align-2 {
    stroke: rgba(255,255,255,.90);
    stroke-width: .1;
}
#aht6 .aht2,
#aht7 .aht2 {
    fill: rgba(134, 7, 7, 0.8);
    stroke: rgb(220, 223, 44);
    stroke-width: 0.5px;  /**/
    stroke-width:0;
}
#g0 use:nth-of-type(2n) {
    fill:lime;
    fill: inherit;
}
#svg g:nth-of-type(2n) {
    fill: inherit;
     /* fill:lime;
  background-color: lime; */
}
/*
#svg use[href="#aht1"]:nth-of-type(4n) {
    fill:yellow;
}
#svg use[href="#aht1"]:nth-of-type(4n+1) {
    fill:blue;
}
#svg use[href="#aht1"]:nth-of-type(4n+3) {
    fill:green;
}
#svg use[href="#aht1"]:nth-of-type(4n+2) {
    fill:tan;
}
*/
/*
#svg use[href="#aht1"]:nth-of-type(4n+3) {
    fill:rgb(179, 19, 72);
}

#svg use[href="#gr3-1"]:nth-of-type(5n+4) {
    fill:yellow;
}
*/
#svg #p1 {
    fill: inherit;
}
#svg #aht1 {
    fill:inherit;
}
#svg #path-aht1 {
    fill:inherit;
}
#svg #invariant-circle {
    fill:rgba(255,0,0,.5);
    stroke:none;
    stroke-width:0;
}
#svg #invariant-text {
    text-anchor: middle;
    font-size: 2em;
    fill:black;
    font-family: "Fira Code VF"
}
</style>
<circle id="c1" class="primitive" x="0"
     y="0" cx="320" cy="320" r="300" fill="#555"
     stroke="tan" stroke-width=".2" />
<g id="gr0" class="primitive" transform="scale(80)">
    <circle id="c0" cx="8" cy="8" r="7.75" class="c0" />
</g>
<g id="gr00" class="primitive" transform="scale(80)">
    <circle id="c00" cx="8" cy="8" r="7.75" class="c00" />
</g>
<g id="gr2" class="primitive" transform="scale(30)" x="0" y="0">
    <rect id="r1" class="r0" height="8" width="8" />
    <path id="p1" class="p0" d="M 1 1 h 3 v 1 h -2 v 5 h -1 v -6" />
</g>
<g id="gr2-2" class="primitive" transform="scale(40)" x="0" y="0">
    <rect id="r1" class="r0" height="16" width="16" />
    <path id="p1" class="p0" d="M 1 9 h 3 v 1 h -2 v 5 h -1 v -6" />
</g>
<g id="gr2-3" class="primitive" transform="scale(40)" x="0" y="0">
    <rect id="r1" class="r0" height="16" width="16" />
    <path id="p1" class="p0" 
        d="M 1 11 h 2 v .666667 h -1.333333 v 3.3333333 h -.6666667 v -4" />
</g>
<g id="gr2-4" class="primitive" transform="scale(40)" x="0" y="0">
    <rect id="r1" class="r0" height="16" width="9" />
    <path id="p1" class="p0" 
        d="M 1 11 h 2 v .666667 h -1.333333 v 3.3333333 h -.6666667 v -4" />
</g>
<g id="gr3" class="primitive" transform="scale(40)" x="0" y="0">
    <rect id="r1" class="r0" height="16" width="16" />
    <path id="p1" class="p0" d="M 2 2 h 6 v 2 h -4 v 10 h -2 v -12" />
</g>
<g id="gr3-1" class="primitive" transform="scale(40)" x="16" y="0">
    <rect id="r1" class="r0" height="16" width="8" />
    <path id="p1" class="p0" d="M 2 2 h 6 v 2 h -4 v 10 h -2 v -12" />
</g>
<g id="sc1" class="primitive" transform="scale(40)" x="0" y="0">
    <rect id="r2" x="0" y="0" height="16" width="16" />
</g>

<g id="sc2" class="primitive" transform="scale(40)" x="0" y="0">
    <rect id="r3" x="0" y="0" height="16" width="16" />
    <rect id="r4" x="5.333" y="5.333" height="5.333" width="5.333" />
</g>

<g id="sc3" class="primitive" transform="scale(48)" x="0" y="0">
    <rect id="r3" x="0" y="0" height="32" width="32" />
    <rect id="r4" x="5.333" y="5.333" height="5.333" width="5.333" />
</g>

<g id="sc4" class="primitive" transform="scale(40)" x="0" y="0">
    <rect id="r5" x="0" y="0" height="32" width="32" />
    <rect id="r6" x="5.333" y="5.333" height="5.333" width="5.333" />
</g>

<g id="sc5" class="primitive" transform="scale(10)" x="0" y="0">
    <rect id="r5" x="0" y="0" height="32" width="32" />
    <rect id="r6" x="5.333" y="5.333" height="5.333" width="5.333" />
</g>
<g id="aht1" class="primitive" transform="scale(10)" x="0" y="0">
    <path id="path-aht1" class="aht1" d="M 0 0 h 64 v 64 h -32 v -32 h -32 v -32" />
</g>
<g id="aht2" class="primitive" transform="scale(10)" x="0" y="0">
    <path id="path-aht2" class="aht1" d="M 0 0 h 32 v 64 h -32 v -64"/>
</g>

<g id="aht4" class="primitive" transform="scale(10)" x="0" y="0">
   <!-- <use href="#alignment-1" transform="scale(.1)" />-->
    <path id="path-aht4" class="aht1" d="M 0 32 L 16 4.2871870789 h 32 L 64 32 Z"/>
</g>

<g id="aht4-1" class="primitive" transform="scale(10)" x="0" y="0">
    <!-- <use href="#alignment-1" transform="scale(.1)" />-->
     <path id="path-aht4-1" class="aht1" 
        d="M 16 0 h 32 L 64 27.71281292110204 h -64 Z" />
 </g>
 
<g id="aht4-2" class="primitive" transform="scale(10)" x="0" y="0">
    <!-- <use href="#alignment-1" transform="scale(.1)" />-->
    <use href="#alignment-2" transform="scale(.1)" />
    <path id="path-aht4-2" class="aht1" d="M 16 32 h 32 L 64 4.2871870789 h -64 Z"/>
 </g>
 
<g id="aht5" class="primitive" transform="scale(10)" x="0" y="0">
     <use href="#alignment-1" transform="scale(.1)" />
     <path id="path-aht5" class="aht1" d="M 0 32 L 16 4.2871870789 h 32 L 64 32 Z"/>
 </g>

<g id="aht7" class="primitive" transform="scale(10)" x="0" y="0">
    <use href="#alignment-2" transform="scale(.1)" />
    <path id="path-aht7" class="aht2" d="M 32 32 L 16 59.71281292 L 48 59.71281292 Z"/>
</g>

<g id="prim-button">
    <use id="prim-use" href="#gr0" x="0" y="0" />
</g>
<g id="invariant">
    <circle id="invariant-circle" cx="0" cy="0" r="10" />
    <text id="invariant-text" >L</text>
</g>

<g id="alignment-2" class="primitive" transform="scale(10)" x="0" y="0">
    <line class="align-1" y1="-64" x1="0" y2="128" x2="0"  /><!-- left border line -->
    <line class="align-2" y1="-64" x1="0" y2="128" x2="0"  /> <!-- white left border line -->

    <line class="align-1" y1="-64" x1="64" y2="128" x2="64"  /> <!-- right border line -->
    <line class="align-2" y1="-64" x1="64" y2="128" x2="64"  />

    <line class="align-1" x1="-64" y1="0" x2="128" y2="0"  /> <!-- top border line -->
    <line class="align-2" x1="-64" y1="0" x2="128" y2="0"  /> <!-- white top border line -->

    <line class="align-1" x1="-64" y1="32" x2="128" y2="32"  /> <!-- Middle horizontal line -->
    <line class="align-2" x1="-64" y1="32" x2="128" y2="32"  />

    <line class="align-1" x1="-64" y1="64" x2="128" y2="64"  /> <!-- bottom border -->
    <line class="align-2" x1="-64" y1="64" x2="128" y2="64"  />
</g>
<g id="alignment-1" class="primitive" transform="scale(10)" x="0" y="0">
    <line class="align-1" y1="-64" x1="0" y2="128" x2="0"  /> <!-- top border line -->
    <line class="align-2" y1="-64" x1="0" y2="128" x2="0"  /> <!-- white top border line -->
    <line class="align-1" y1="-64" x1="16" y2="128" x2="16"  />
    <line class="align-2" y1="-64" x1="16" y2="128" x2="16"  />
    <line class="align-1" y1="-64" x1="32" y2="128" x2="32"  />
    <line class="align-2" y1="-64" x1="32" y2="128" x2="32"  />
    <line class="align-1" y1="-64" x1="48" y2="128" x2="48"  />
    <line class="align-2" y1="-64" x1="48" y2="128" x2="48"  />
    <line class="align-1" y1="-64" x1="64" y2="128" x2="64"  />
    <line class="align-2" y1="-64" x1="64" y2="128" x2="64"  />

    <line class="align-1" x1="-64" y1="0" x2="128" y2="0"  /> <!-- left border line -->
    <line class="align-2" x1="-64" y1="0" x2="128" y2="0"  /> <!-- white top border line -->
    <line class="align-1" x1="-64" y1="16" x2="128" y2="16"  />
    <line class="align-2" x1="-64" y1="16" x2="128" y2="16"  />
    <line class="align-1" x1="-64" y1="32" x2="128" y2="32"  />
    <line class="align-2" x1="-64" y1="32" x2="128" y2="32"  />
    <line class="align-1" x1="-64" y1="48" x2="128" y2="48"  />
    <line class="align-2" x1="-64" y1="48" x2="128" y2="48"  />
    <line class="align-1" x1="-64" y1="64" x2="128" y2="64"  />
    <line class="align-2" x1="-64" y1="64" x2="128" y2="64"  />
</g>
</defs>

<g id="euclidian-transform-xy-plane" >
    <path id="dashed-pos-boundary" d="M 0 640 h 640 v -640" />
    <line y1="0" x1="-100%" x2="100%" y2="0" stroke="black" stroke-width="1" />
    <line x1="0" y1="-100%" y2="100%" x2="0" stroke="black" stroke-width="1" />
    
</g>

<g id="composition-table">
<use id="show" href="#gr0" transform="scale(1.00)"></use>
</g>
<path id="dim-past-boundary" d="M 1 641 h 640 v -640 h 128 v 766 h -766 v -128" />
</svg>
</div>
<div id="controls-2">
<form id="matrixForm" onSubmit="return false;">
<fieldset>
<legend>Start Image</legend>
<ul id="image-buttons">
<li>

</ul>
</fieldset>
<fieldset>
<legend> Transform #</legend>
<ul id="mrcm-buttons">

</ul>
</fieldset>
</form>
</div>
<style>
#log-parent {
    display:none;
}

div:first-of-type {
  display: inline-flex;
  align-items: flex-start;
  margin-bottom: 5px;
}

label {
  /*margin-right: 15px;*/
  line-height: 10px;
}

input {
  -webkit-appearance: none;
  -moz-appearance: none;
  appearance: none;

  border-radius: 50%;
  width: 16px;
  height: 16px;

  border: 2px solid #999;
  transition: 0.2s all linear;
  margin-right: 5px;

  position: relative;
  top: 4px;
}

input:checked {
  border: 6px solid black;
}

button.x,
legend.x {
  color: black;
  background-color: white;
  padding: 5px 10px;
  border-radius: 0;
  border: 2px solid transparent;
  font-size: 14px;
}

button:hover,
button:focus {
  color: #999;
  border:2px solid red;
}

button:active {
  background-color: white;
  color: black;
  outline: 2px solid black;
}
#controls-2 input[type="radio"] {
    height:0;
    width:0;
    border:none;
    margin:0;
    padding:0;
}
#controls-2 #image-buttons, 
#controls-2 #mrcm-buttons {
    display: inline-flex;
    flex-direction: column;
    flex-wrap: wrap;
}
#controls-2 #image-buttons li,
#controls-2 #mrcm-buttons li {
    display: inline-flex;
    flex-wrap: wrap;
    flex-direction: column;
    padding-left: 10px;
    padding-bottom: 3px;
    width: 70px;
}
#controls-2 fieldset {
    display: inline-flex;
    justify-content: flex-start;
    max-height:1000px;
    width: 200px;
}
#matrixForm {
    vertical-align: top;
    display: inline-flex;
}
#matrixForm button {
    padding:2px;
    margin:0;
    border:0;
}
</style>
<script>

function updateInitialImage(href) {
    let target = document.querySelector("#g0"),
        targets;

    if (target) {
        targets = target.querySelectorAll("use");
        for (let i=0;i<targets.length;i++) {
            targets.item(i).setAttribute("href",href)
        }
    } else {
        document.getElementById("show").setAttribute("href",href);
    }
    document.querySelector("use#prim-use").setAttribute("href",href)
 
}

function primitiveItemTemplate(index,primitive) {
    return html = `<li>
<button id="prim-button-${index}">
<label for="initial-image-${index}" onClick="updateInitialImage('${primitive}')" >
<svg 
    id="svg-prim-button-${index}"
    x="0"
    y="0"
    width="64"
    height="64"
    >
    <use href="${primitive}" x="0" y="0" transform="scale(0.1)" />
</svg>
</label>
</button>
<input name="initial-image" id="initial-image-0" value="${primitive}" type="radio"/>
</li>`
}
function matrixItemTemplate(index,group) {
    return `<li>
<label for="apply-mrcm-${index}">
<button id="mrcm-${index}" onClick="apply(${index})">
<svg 
    id="svg-mrcm-${index}"
    x="0"
    y="0"
    width="64"
    height="64"
    >
    ${group}
</svg>
</button>
</label>
<input name="apply-mrcm" id="apply-mrcm-${index}" value="${index}" type="radio" />
</li>`;
}


function writeImageButtons(parentId,listSelector) {
    let formParent = $(`#${parentId}`),
        imageList = $(listSelector),
        id;
        formParent.html("")
        for (let i=0;i<imageList.length;i++) {
            id=imageList[i].id;
            formParent.append(primitiveItemTemplate(i,`#${id}`))
        }
}

function writeMatrixButtons(parentId,mrcmArray) {
    let formParent = $(`#${parentId}`),
        imageList = $(listSelector);
        
        formParent.html("")

        for (let i=0;i<mrcmArray.length;i++) {
            let mrcm = mrcmArray[i].M,
                len  = mrcm.length,
                group = `<g x="0" y="0" id="g-button-${i}" transform="scale(.1)">\n`;
            for (let m=0;m<mrcm.length;m++) {
                group += `\t<use href="#prim-button" transform="${mrcm[m].toMatrix()}"/>\n `;
            }        
            group += "</g>";

            formParent.append(matrixItemTemplate(i,group))
            
        }
}

var listSelector  = "#svg defs .primitive";
var imageParentId = "image-buttons";
var mrcmParentId  = "mrcm-buttons";

function apply(matrixId) {
    let initialImage = d3.select("#prim-use").attr("href");
    applyAllMatrices(initialImage,CM[matrixId].M)
}

function initDisplay() {
    let initialImage = d3.select("#prim-use").attr("href");
    while (subGroups.length) {
        let sg = subGroups.pop();
         if (sg === initialImage) {
             break;
         }
         d3.select(sg).remove();
    }
    updateInitialImage("#gr3");
    writeImageButtons("image-buttons",listSelector);
    writeMatrixButtons("mrcm-buttons",CM)
}

window.addEventListener('DOMContentLoaded', () => {
    Log.Notice('Document Ready');
    Log.Remove();
    initDisplay();
}
);
</script>
</body>
</html>