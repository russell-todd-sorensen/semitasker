<!DOCTYPE html>
<html lang="en-US">
<head>
<meta charset="utf-8">

<title>Multiple Reduction Copy Machine using Affine Transforms</title>
<style>

body,html {
  font-family:"Lucida Console", Monaco, monospace;
  background-color: white;
  margin:0;
  padding:0;
  border:0;
}

#composite {
    position: relative;
    width: 80%;
}
#svg {
    margin: 15px;
}
#svg2 {
    position: absolute;
    top: 15.5px;
    left: 30.5px;
}

#main, #main2 {
    position: relative;
    border: 3px solid black;
    display: inline-block;
}

#myCanvas, #myCanvas2 {
    border: 1px solid #444;
    margin-top: 15px;
    margin-left: 30px;
    background-clip:padding-box;
    background-color: black;
}

#box, #box2 {
    position: absolute;
    top: 0;
    right: 0;
    background-color: rgba(255,0,0,.1);
    border: 1px solid black;
}

#controls {
    font-family: "Consolas Bold";
    color: white;
    background-color: #444;
    position: absolute;
    right: 0;
    top: 0;
    display: none;
}

#controls-2 {
    font-family: "Consolas Bold";
    color: white;
    background-color: #444;
    position: absolute;
    right: 0;
    top: 0;
}

#colors {
    border: 2px solid #555;
    position: absolute;
    right: 285px;
    top: 3px;
}

#controls ul,
#controls-2 ul {
    font-family: inherit;
    list-style: none;
    padding: 0;
    width: 270px;
}


#controls input, #controls-2 input,
#controls select, #controls-2 select {
    display: inline-block;
    font-family: "Tw Cen MT Bold";
    font-size: 15px;
    width: 162px;
    margin-left: 12px;
}

#controls input[type=range],
#controls-2 input[type=range] {
    width: 200px;
}

/* this is how you change the font of select options!!! */
#theory { /* select id */
    font-family: "Tw Cen MT Bold";
    font-size: 16px;
}

#mode-controls {
    letter-spacing: 1px;
}

#controls input[type=number] {
    width: 60px;
}

#controls #pixelJump input[type=number],
#controls-2 #pixelJump input[type=number] {
    width: 50px;
}

#controls select,
#controls-2 select {
    width: 100px;
}

#hide {
    display: none;
}
circle {
    fill: inherit;
}
</style>
<script>

var M = new Array();
var Points = new Array();
var w = 600;
var h = 600;
var left = 30;
var w1 = w + left;
var numPoints = 100000;
</script>

<script src="https://ajax.googleapis.com/ajax/libs/d3js/3.5.17/d3.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script src="/js/log-2.js"></script>
<script src="js/matrix2.js" charset="utf-8"></script>
<script src="js/mrcm-affine.js" charset="utf-8"></script>
<script src="js/matrix-math.js" charset="utf-8"></script>
<script>

function applyMatrix(groupId,href,matrix) {
    let svg = d3.select("#svg"),
        show = svg.select("#show"),
        group = svg.select(`#${groupId}`);

    group.append("use")
        .attr("href",href)
        .attr("transform",matrix.toMatrix())
        .attr("opacity",matrix.pct);

    show.attr("href",`#${groupId}`);
}

function groupAppend(group,href,matrix) {
    group.append("use")
        .attr("href",href)
        .attr("transform",matrix.toMatrix());
}

function applyAllMatrices(href,matrix) {
    let len = matrix.length,
        svg = d3.select("#svg"),
        show = svg.select("#show"),
        defs = svg.select("defs"),
        lastGid = `g${subGroups.length}`;
    if (subGroups.length) {
        href = `#g${subGroups.length-1}`;
    }
    subGroups.push(href);
    defs.append("g")
        .attr("id",lastGid);
    let group = defs.select(`#${lastGid}`);
    show.attr("href",`#${lastGid}`);

    for (let i=0;i<len;i++) {
        groupAppend(group,href,matrix[i]);
    }

}
var subGroups = [];
/////////// NOTE /////////////
///Zeroing out the CM array to use indexes == labels
CM=[];
var wd=64,
    ht=64;
CM.push(  // Matrix 0: d0 (AKA: neutral element e)
    new MRCM(wd,ht,CM.length,`Matrix ${CM.length}: Symmetry Transformations of the Square (d0)`,
        {a:1,b:0,c:0,d:1,e:0,f:0,pct:1.0000},  // V1(x,y) = (x,y)
    )
);
CM.push(  // Matrix 1: d1 (Horizontal Mirror) 
    new MRCM(wd,ht,CM.length,`Matrix ${CM.length}: Symmetry Transformations of the Square (d1)`,
       // {a:1,b:-1,c:-1,d:1,e:1,f:0,pct:1.0000},  // V1(x,y) = (y,x)
       {a:0,b:1,c:-1,d:0,e:1,f:0,pct:1.0000},  
    )
);
CM.push(  // Matrix 2: d2 (rotate 180deg clockwise)
    new MRCM(wd,ht,CM.length,`Matrix ${CM.length}: Symmetry Transformations of the Square (d2)`,
        {a:-1,b:0,c:0,d:-1,e:1,f:1,pct:1.0000},  // V1(x,y) = (1-x,1-y)
    )
);
CM.push(  // Matrix 3: d3 (Horizontal Mirror) d1^3
    new MRCM(wd,ht,CM.length,`Matrix ${CM.length}: Symmetry Transformations of the Square (d3)`,
        {a:0,b:-1,c:1,d:0,e:0,f:1,pct:1.0000},  // V1(x,y) = (y,x)
    )
);
CM.push(  // Matrix 4: d4 (Horizontal Mirror)
    new MRCM(wd,ht,CM.length,`Matrix ${CM.length}: Symmetry Transformations of the Square (d4)`,
        {a:1,b:0,c:0,d:-1,e:0,f:1,pct:1.0000},  // V1(x,y) = (x,1-y)
    )
);
CM.push(  // Matrix 5: d5 (Vertical Mirror) = (d1^2)*d4
    new MRCM(wd,ht,CM.length,`Matrix ${CM.length}: Symmetry Transformations of the Square (d5)`,
        {a:-1,b:0,c:0,d:1,e:1,f:0,pct:1.0000},  // V1(x,y) = (1-x,y)
    )
);
CM.push(  // Matrix 6: d6 (Horizontal Mirror)
    new MRCM(wd,ht,CM.length,`Matrix ${CM.length}: Symmetry Transformations of the Square (d6)`,
        {a:0,b:1,c:1,d:0,e:0,f:0,pct:1.0000},  // V1(x,y) = (y,x)
    )
);
CM.push(  // Matrix 7: d7 (Horizontal Mirror) (d1^3)*d4
    new MRCM(wd,ht,CM.length,`Matrix ${CM.length}: Symmetry Transformations of the Square (d7)`,
        {a:0,b:-1,c:-1,d:0,e:1,f:1,pct:1.0000},  // V1(x,y) = (y,x)
    )
);

//////////// END OF BASIC TRANSFORMATIONS ON UNIT SQUARE ///////////////////
if (false) {

    CM.push(  // Matrix 18: xx (Horizontal Mirror) (d1^3)*d4 ??
        new MRCM(640,640,CM.length,`Matrix ${CM.length}: Symmetry Transformations of the Square (xx)`,
            {a:0,b:-1,c:-1,d:0,e:1,f:1,pct:1.0000},  // V1(x,y) = (y,x)
        )
    );
    CM.push(  // Matrix 20: xx (Horizontal Mirror) 
        new MRCM(640,640,CM.length,`Matrix ${CM.length}: Symmetry Transformations of the Square (xx)`,
            {a:1,b:1,c:1,d:-1,e:0,f:0,pct:1.0000},  // V1(x,y) = (y,x)
        )
    );
    CM.push(  // Matrix 10: Squares1
        new MRCM(640,640,CM.length,`Matrix ${CM.length}: Squares1`,
            {a:.5,b:0,c:0,d:.5,e:0,f:.5,pct:.333333},
            {a:.5,b:0,c:0,d:.5,e:0,f:0,pct:.333333},
            {a:.5,b:0,c:0,d:.5,e:.5,f:.5,pct:.333334},
        )
    );
    CM.push(  // Matrix 11: Squares2
        new MRCM(640,640,CM.length,`Matrix ${CM.length}: Squares2`,
            {a:.5,b:0,c:0,d:.5,e:0,f:0,pct:.333333},  // V1(x,y) = (x/2,y/2)
            {a:.5,b:0,c:0,d:.5,e:.5,f:0,pct:.333334}, // V2(x,y) = ((x+1)/2,y/2)
            {a:.5,b:0,c:0,d:.5,e:0,f:.5,pct:.333333}, // V3(x,y) = (x/2,(y+1)/2)
        )
    );
}
</script>

</head>
<body>
<div id="no-hide">
 <!--  <svg id="svg" x="-10" y="-10" height="660" width="660" viewBox="-10 -10 660 660">-->
 <svg id="svg" x="-127" y="-127" height="1024" width="1024" viewBox="-127 -127 1024 1024">
<defs id="defs1">
<style>
#svg {
    border:1px dashed tan;
}
#svg text {
    font-size: 620px;
    fill: black;
    font-family: 'Lucida Sans', 'Lucida Sans Regular', 'Lucida Grande', 'Lucida Sans Unicode', Geneva, Verdana, sans-serif;
    font-weight: normal;
    text-anchor:middle;
}
#gr0 rect {
    fill:transparent;
    stroke-width:2px;
    stroke:tomato;
}
#gr1 rect {
    stroke: purple;
    stroke-width: 2;
    fill: transparent;
}
.r0 {
    fill: rgba(0,0,0,.1);
}
</style>
<circle id="c1" x="0" y="0" cx="300" cy="300" r="300" fill="#000" />
<circle id="c2" x="0" y="0" cx="32" cy="32" r="30" fill="#000" />
<g id="gr1" transform="scale(0.1)">
 <rect id="r1" x="2" y="2" height="600" width="300" />
 <text id="t1" x="10" y="140" >L</text>
</g>
<g id="gr00" transform="scale(0.1)">
    <rect id="r1" x="2" y="2" height="636" width="636" />
    <text id="t1" x="320" y="620">R</text>
</g>
<g id="gr0" transform="scale(0.1)">
    <rect id="r1" x="2" y="2" height="636" width="636" />
    <text id="t1" x="320" y="620"transform="rotate(180,320,320)">R</text>
</g>
<g id="gr2" transform="scale(80)" x="0" y="0">
    <rect id="r1" class="r0" height="8" width="8" />
    <path id="p1" class="p0" d="M 1 1 h 3 v 1 h -2 v 5 h -1 v -6" />
</g>
<g id="gr3" transform="scale(4)" x="0" y="0">
    <rect id="r1" class="r0" height="16" width="16" />
    <path id="p1" class="p0" d="M 2 2 h 6 v 2 h -4 v 10 h -2 v -12" />
</g>
</defs>

<g id="euclidian-transform-xy-plane" >
    <line y1="0" x1="-100%" x2="100%" y2="0"  stroke="black" stroke-width="1" />
    <line x1="0" y1="-100%" y2="100%" x2="0"  stroke="black" stroke-width="1" />
</g>
<g id="composition-table">

</g>
</svg>
</div>
<script>

var compTable = d3.select("#composition-table")

function buildPrimitive(defs,baseId,primId,matrix) {
    let g = defs.append("g")
            .attr("id",primId);

    g.append("use")
        .attr("href",`#${baseId}`)
        .attr("transform",matrix);

    return g;
}

function buildCompositions(defsId,baseId,compId,cm) {

    let k = 0,
        l = 0,
        x,
        y,
        len = cm.length,
        primMap = new Map(),
        compMap = new Map(),
        matrix = null,
        height,
        width,
        defs = d3.select(`#${defsId}`),
        comp = d3.select(`#${compId}`);

    for (let i=0;i<len;i++) {
        matrix = cm[i].M[0].toMatrix();
        height = cm[i].h;
        width  = cm[i].w;
        primId = `p-d${i}`
        primMap.set(primId,buildPrimitive(defs,baseId,primId,matrix));
        comp.append("use").attr("href",`#${primId}`).attr("y",-1*height).attr("x",i*width);
        comp.append("use").attr("href",`#${primId}`).attr("x",-1*width).attr("y",i*height);
    }

    //return primMap;

    for (l=0;l<len;l++) {
        y=l*height;
        let lPrimitiveId = `p-d${l}`;
        for (k=0;k<len;k++) {
            x = k*width;
            let kMatrix = cm[k].M[0].toMatrix(),
                cId = `c-d${l}-d${k}`;
            compMap.set(cId,buildPrimitive(defs,lPrimitiveId,cId,kMatrix));
            comp.append("use").attr("href",`#${cId}`).attr("y",y).attr("x",x).data(`l=${l},k=${k}`);
            //let outer = ct.append("g")
            //    .attr("transform",mtk);
            //let inner = outer.append("g")
            //    .attr("transform",mtl)
            //    .attr("data",`k=${k},l=${l}`);
            //let final = inner.append("use")
            //    .attr("href",href)
             //   .attr("x",x)
            //    .attr("y",y);

            //    .attr("transform",`${mtl} ${mtk}`);

            console.log(`k=${k},l=${l},x=${x},y=${y}`)
        }
    }
    return {primMap:primMap,compMap:compMap};
}
//try inner g and outer g for transforms
</script>

<style>
#log-parent {
    display:none;
}
</style>
</body>
</html>