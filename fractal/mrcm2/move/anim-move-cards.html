<!DOCTYPE html>
<html lang="en-US">
<head>
<meta charset="utf-8" >
<title>Shuffle Cards</title>
<link rel="stylesheet" href="/css/main.css" >
<link rel="stylesheet" href="css/anim-move-form.css">
<link rel="stylesheet" href="css/anim-move-grid.css" >
<link rel="stylesheet" href="css/anim-move-svg.css" >

<script src="https://ajax.googleapis.com/ajax/libs/d3js/3.5.17/d3.min.js" defer ></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js" defer ></script>
<script src="/js/queue-function.js"></script>
<script src="js/probability-and-stats.js" defer ></script>
<script src="js/anim-move-svg.js" defer ></script>
<script src="js/page-state.js" defer ></script>
<script src="js/visualization.js" defer ></script>
<script src="js/card-shuffle.js" defer ></script>
<script src="js/anim-move-strategy.js" defer ></script>
<script src="js/anim-move-path.js" defer ></script>
</head>
<body>

<div id="all">
<div id="main">
<div id="controls">
<form id="form1"
    action=""
    method="GET"
    oninput="rows.value=Math.ceil(parseInt(gSize.value)/parseInt(cols.value))"
    onSubmit="() => {return false;}">
<fieldset id="fs1">
<ul id="ul1">
<li>
    <label for="gSize">Cards</label>
    <input id="gSize" name="gSize" value="13" type="number" min="1" step="1" >
</li>
<li>
    <label for="cols"><nobr>Per Suit</nobr></label>
    <input id="cols" name="cols" value="5" type="number" min="1" step="1" >
</li>
<li>
    <label>Suits</label><output id="rows" name="rows" form="form1" ></output>
</li>
</ul>
<ul id="ul2">
<li>
    <input type="button" value="Layout Cards" onClick="myAnimControl.init('svg-container');currentStep.value='-,0'">
</li>
<li>
    <input type="button" value="Shuffle" onClick="initFollowNumbers('form1');">
</li>
<li><div id="prev-curr-next"><nobr><input type="button" value="&lt;&nbsp;" onClick="currentStep.value=myAnimControl.prev();"><output
        id="currentStep" name="currentStep" form="form1" >-,0</output><input
        type="button" value="&nbsp;&gt;"
        onClick="currentStep.value=myAnimControl.next();"></div></li>
</ul>
</fieldset>
</form>
</div>
<div id="file-box-room">
    <p>ooo</p>
</div>
<div id="ideasAndCommentary" >
<li>

</li>
</div>
<!-- reuseable template for svg doc-->
<!-- https://developer.mozilla.org/en-US/docs/Web/HTML/Element/template -->
<template id="svg-template" type="image/svg+xml"><svg
    id="svgtmp"
    xmlns:svg="http://www.w3.org/2000/svg"
    xmlns="http://www.w3.org/2000/svg"
    xmlns:xlink="http://www.w3.org/1999/xlink"
    x="0"
    y="0"
    width="100%"
    height="100%"
    >
<style id="svg-styles">
#main,
#svg-test-container {
    display: inline-block;
    vertical-align: top;
}
svg#svgvis {
    fill:transparent;
    background-color:transparent;
    stroke:white;
    stroke-width:2;
}
svg#svgvis text {
    fill:black;
}
svg g#main rect#bg,
svg g#main ellipse#ellipse1 {
    fill: transparent;
    background-color: transparent;
    stroke: white;
    stroke-width: 2;
}
#path3 {
    stroke: yellow;
    stroke-width:2;
}
#path4 {
    stroke: cyan;
    stroke-width:2;
}
#path1 {
    stroke: purple;
    stroke-width:2;
}
#item {
    stroke: black;
    stroke-width: 1;
    fill: transparent;
    text-anchor:middle;
    font-size:3em;
}
#item text,
#item-rect {
    stroke: inherit;
    stroke-width: inherit;
    font-size: inherit;
    fill: inherit;
    text-anchor: inherit;
}
#file-box-room #atext text,
#file-box-room #col-heads text,
#file-box-room #row-heads text,
#file-box-room #data-grid text {
    stroke:none;
    font-size: 3em;
    text-anchor:middle;
    transform: translate(1em,1.3em);
}
#a2bPath {
    fill:none;
    stroke:rgba(154, 205, 50,1);
    stroke-width:3;
    stroke-opacity: 1;
    stroke-linecap:calc(stroke-width*2) round;
}
#b2aPath {
    fill:none;
    stroke:rgba(210,0,0,1);
    stroke-width:3;
    stroke-opacity: 1;
    stroke-linecap:round;
}
#a2bLine {
    stroke:white;
    stroke-width:3;
    stroke-opacity: 1;
    stroke-linecap:round;
}
#centroid {
    stroke:#800080;
    stroke-opacity: .8;
    stroke-width:2;
    fill:white;
}

#row-heads.row-grid .♣ text,
#row-heads.row-grid .♠ text,
#row-heads.row-grid .♧ text,
#row-heads.row-grid .♤ text,
#data-grid .data.♣ text,
#data-grid .data.♠ text,
#data-grid .data.♧ text,
#data-grid .data.♤ text {
    fill:black;
}
#row-heads.row-grid .♦ text,
#row-heads.row-grid .♥ text,
#row-heads.row-grid .♢ text,
#row-heads.row-grid .♡ text,
#data-grid .data.♦ text,
#data-grid .data.♥ text,
#data-grid .data.♢ text,
#data-grid .data.♡ text {
    fill:red;
}
#data-grid g.data.inactive {
    opacity: 0.05;
}
</style>
<defs id="defs">
<g id="item">
    <rect id="item-rect" x="0" y="0" height="100" width="100" rx="10" ry="10" />
</g>

<filter>
<animateMotion
    id="animation-template"
    begin="pris0.click"
    dur="2s"
    calcMode="spline"
    path=""
    repeatCount="1"
    fill="freeze"
    values="0; .25; .35; .5; .35; .15; 0"
    keyTimes="0; 0.25; 0.5; 0.75; 1"
    keySplines="0.5 0 0.5 1; 0.5 0 0.5 1; 0.5 0 0.5 1; 0.5 0 0.5 1">
    <mpath id="mp0" href="" />
</animateMotion>
</filter>
</defs>
<rect id="bg" x="0" y="0" height="100%" width="100%" />
<g id="path-display" transform="translate(140,140)">
    <path id="a2bPath" transform="translate(0,0)" d="" />
    <path id="b2aPath" transform="translate(0,0)" d="" />
    <line id="a2bLine" x1="0" y1="0" x2="0" y2="0" />
    <circle id="centroid" cx="-500" cy="-500" r="3" />
</g>
</svg></template>
<script>

var Log = {};
Log.msg = function(msg) {};
Log.Notice = Log.Error = Log.Warning = Log.Debug = Log.Hide = Log.Show = Log.Remove = Log.msg;

var pState,
    myVis,
    myCardShuffle,
    shuffleSwaps,
    myAnimControl,
    animQueue;

var config = {
    mode: "url2form",
    map: [
        {
            urlvar:"gs",
            default:52,
            form:"form1",
            formvar:"gSize",
            param:"numPrisoners",
        },
        {
            urlvar:"cols",
            default:13,
            form:"form1",
            formvar:"cols",
            param:"numColumns",
        },
    ],
}

class AnimControl {
    vis;
    #queue;
    steps;
    firstStep;
    lastStep;
    current = {next:0,prev:null}
    constructor(vis) {
        this.vis=vis;
    }
    next() {
        let stepToExec = this.current.next,
            nextText;
        if (stepToExec === null) {
            return `${this.current.prev},+`;
        }
        this.vis.animateDataSwap(...this.steps[stepToExec]);
        this.current.prev = stepToExec;
        if (stepToExec < this.lastStep) {
            this.current.next++;
            nextText = this.current.next;
        } else {
            this.current.next=null
            nextText = "+"
        }
        return `${this.current.prev},${nextText}`;
    }
    prev() {
        let stepToExec = this.current.prev,
            prevText;
        if (stepToExec === null) {
            return `-,${this.current.next}`;
        }
        this.vis.animateDataSwap(...this.steps[stepToExec]);
        this.current.next = stepToExec;
        if (stepToExec > this.firstStep) {
            this.current.prev--;
            prevText = this.current.prev;
        } else {
            this.current.prev=null
            prevText = "-"
        }
        //return this.current.prev;
        return `${prevText},${this.current.next}`
    }
    init(containerId) {
        this.vis.setupGrid(containerId);
        this.createSwaps();
    }
    initQueue(containerId,animData=null) {
        this.init();
        if (animData === null) {
            return;
        }
        this.animData = Object.assign(
            {
                prev:this.prev,
                next:this.next,
                timeout:2300,
            },animData);
    }
    createSwaps() {
        let shuffleInfo = shuffleSteps(this.vis.getItemCount());
        this.steps = shuffleInfo.steps;
        this.stepCount = this.steps.length;
        this.final = shuffleInfo.final;
        this.firstStep = 0;
        this.lastStep = this.stepCount-1;
        this.current = {next:0,prev:null};
    }
}

window.addEventListener('DOMContentLoaded', () => {
    // The current state of url and form is gathered here:
    pState = new PageState({
        config: config,
        events: [{target:"form1",desc:["input",{"bubbles":true, "cancelable":false}]}]
    });
    
    myCardShuffle = new CardShuffle(pState);
    myAnimControl = new AnimControl(myCardShuffle);
    myAnimQueue   = new Queue();
});
</script>
<script>

</script>

<div id="svg-container"></div>
</div> <!-- end main -->
<div id="svg-test-container">
<svg
    id="svg-test"
    xmlns:svg="http://www.w3.org/2000/svg"
    xmlns="http://www.w3.org/2000/svg"
    xmlns:xlink="http://www.w3.org/1999/xlink"
    x="0"
    y="0"
    width="2500"
    height="3000"
    >
<defs>
<style>
#ellipseA,
#ellipseAdxdyh {
    stroke:#008080;
    stroke-width:3;
    stroke-opacity:0.5;
    fill:rgba(0,0,0,.1);
}
#ellipseB,
#ellipseBdxdyh {
    stroke:#800080;
    stroke-width:3;
    stroke-opacity:0.5;
    fill:rgba(0,0,0,.1);
}
#ellipseC,
#ellipseCdxdyh {
    stroke:#808000;
    stroke-width:3;
    stroke-opacity:0.5;
    fill:rgba(0,0,0,.1);
}
#ellipseD,
#ellipseDdxdyh {
    stroke:#808080;
    stroke-width:3;
    stroke-opacity:0.5;
    fill:rgba(0,0,0,.1);
}
#xCoords,
#yCoords,
#xyCoords {
    stroke:white;
    stroke-width:0.75;
    stroke-dashoffset:3;
    stroke-dasharray: 6,2;
    fill:none;
}
#xCoords {
    stroke-dashoffset:5;
}
#yCoords {
    stroke-dashoffset:7;
}
.graph-text {
    font-size: 3em;
}
</style>
<path id="xyCoords" d="M-1250,0 L-1250,0 1250,0 M0,-1000 L0,-1000 0,1000" />
<path id="xCoords" d="M-1250,0 L-1250,0 1250,0" />
<path id="yCoords" d="M0,-1000 L0,-1000 0,4000" />
<g id="ellipseGroupA" transform="translate(1000,0)">
    <g id="ellipseArotate" transform="">
        <path id="ellipseA" d="M0,0 a120,150 0 1,0 240,0" />
        <path id="ellipseAdxdyh" d="M0,0 l240,0 0,0 Z"/>
        <text id="graphA" class="graph-text" transform="translate(250,-250)">A,</text>
    </g>
    <use href="#xCoords" />
    <use href="#yCoords" />
</g>
<g id="ellipseGroupB" transform="translate(1000,0)">
    <g id="ellipseBrotate" transform="">
        <path id="ellipseB" d="M0,0 a120,150 0 1,0 240,0" />
        <path id="ellipseBdxdyh" d="M0,0 l240,0 0,0 Z"/>
        <text id="graphB" class="graph-text" transform="translate(-250,-250)">B,</text>
    </g>
</g>
<g id="ellipseGroupC" transform="translate(1000,1550)">
    <g id="ellipseCrotate" transform="">
        <path id="ellipseC" d="M0,0 a120,150 0 1,0 240,0" />
        <path id="ellipseCdxdyh" d="M0,0 l240,0 0,0 Z"/>
        <text id="graphC" class="graph-text" transform="translate(250,-250)">C,</text>
    </g>
</g>
<g id="ellipseGroupD" transform="translate(1000,1550)">
    <g id="ellipseDrotate" transform="">
        <path id="ellipseD" d="M0,0 a120,150 0 1,0 240,0" />
        <path id="ellipseDdxdyh" d="M0,0 l240,0 0,0 Z"/>
        <text id="graphD" class="graph-text" transform="translate(-250,-250)">D,</text>
    </g>
    <use href="#xCoords" />
</g>
</defs>

<g id="test-area" transform="translate(150,750) scale(.5)">
    <use href="#ellipseGroupB" />
    <use href="#ellipseGroupC" />
    <use href="#ellipseGroupD" />
    <use href="#ellipseGroupA" />
</g>
</svg>
</div>
<script>

</script>
</div> <!-- end all -->
</body>
</html>