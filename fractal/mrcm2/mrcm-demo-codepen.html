<!DOCTYPE html>
<html lang="en-US">
<head>
<meta charset="utf-8">

<title>Multiple Reduction Copy Machine using Affine Transforms</title>
<link rel="stylesheet" type="text/css" href="css/mrcm-demo-2.css" media="all">
<style>
#log-parent {
    display:none;
}
#controls-2 select#matrixId ,
#controls-2 #matrixId option {
    width: 225px;
}
#svg-parent {
    display: none;
}
</style>
</head>
<body>
<div id="svg-parent">
<svg id="svg" x="50" y="50" height="100" width="100" viewBox="50 50 100 100">
<defs id="svg-defs">

</defs>

</svg>
</div>

<style>
</style>
<div id="composite">
<canvas id="myCanvas" height="600" width="600">Your browser doesn't support canvas</canvas>
<div id="mrcm-choice">
<div class="mrcm-button">
</div>
</form>

</div>
</div>

<div id="controls-2">
<form id="matrixForm" onChange="runConfig()" >
<input type="hidden" id="matrix-value" />
<fieldset>
<legend>Copy Machine</legend>
<ul>
<li>
 <label for="matrixId">MRCM:</label>
 <select id="matrixId" name="matrixId" onChange="changeImage()">

 </select>
</li>
</ul>
</fieldset>
<fieldset id="adjust">
<legend onClick="togglePanel('panel-matrix-options');" id="legend1"
    style="cursor: pointer" 
    title="Click to Minimize/Expand">Matrix Adjustments</legend>
<ul id="panel-matrix-options">
 <li>
 <label for="matrixIndex">Matrix:</label>
 <select id="matrixIndex" 
    name="matrixIndex" 
    onChange="loadMatrixTransform()">
  <option value="0" selected="selected">0</option>
  <option value="1">1</option>
  <option value="2">2</option>
  <option value="3">3</option>
  <option value="4">4</option>
  <option value="5">5</option>
  <option value="6">6</option>
  <option value="7">7</option>
  <option value="8">8</option>
  <option value="9">9</option>
 </select>
 </li>
 <li>
  <label for="r">ScaleX:</label>
  <input id="r" name="r" type="range" min="-1.000" max="1.000" step=".01"
         onChange="updateMatrixTransform('r', '#matrix-one');" >
 </li>
 <li>
  <label for="s">ScaleY:</label>
  <input id="s" name="s" type="range" min="-1.000" max="1.000" step=".01"
         onChange="updateMatrixTransform('s', '#matrix-one');" >
 </li>
 <li>
  <label for="t">SkewY:</label>
  <input id="t" name="t" type="range" min="-6.3" max="6.3" step=".01"
         onChange="updateMatrixTransform('t', '#matrix-one');" >
 </li>
 <li>
  <label for="u">SkewX:</label>
  <input id="u" name="u" type="range" min="-6.3" max="6.3" step=".01"
         onChange="updateMatrixTransform('u', '#matrix-one');" >
 </li>
 <li>
  <label for="e">E:</label>
  <input id="e" name="e" type="range" min="-600" max="600" step="1"
         onChange="updateMatrixTransform('e', '#matrix-one');" >
 </li>
 <li>
  <label for="f">F:</label>
  <input id="f" name="f" type="range" min="-600" max="600" step="1"
         onChange="updateMatrixTransform('f', '#matrix-one');" >
 </li>
</ul>
</fieldset>
</form>
</div>
<script>
//var crObj;
//var M = new Array();
var Points = new Array();
var w = 600;
var h = 600;
//var left = 30;
//var w1 = w + left;
var numPoints = 10000;//5000000;
var myImage;
var mrcmIdSelectArray=[];
var panelHidden = false;
var initialConf = {
    matrixId:{
        id:"matrixId",
        value:{
            type:"radio",
            value:"2",
            options:["0","1","2","3","4","5","6","7","8","9","10","11","12","13","14"]
        },
    },
    matrixIndex:{
        id:"matrixIndex",
        value:{
            type:"radio",
            value:"0",
            options:["0","1","2","3","4","5","6","7","8","9"],
        },
    },
    r:{
        id:"r",
        value:{
            type:"range",
            min:-1.000,
            max:1.000,
            value:0.1,
            label:"ScaleX",
        },
    },
    s:{
        id:"s",
        value:{
            type:"range",
            min:-1.000,
            max:1.000,
            value:0.1,
            label:"ScaleY",
        },
    },
    t:{
        id:"t",
        value:{
            type:"range",
            min:-2*Math.PI,
            max:2*Math.PI,
            value:0.0,
            label:"SkewY",
        },
    },
    u:{
        id:"u",
        value:{
            type:"range",
            min:-2*Math.PI,
            max:2*Math.PI,
            value:0.0,
            label:"SkewX",
        },
    },
    e:{
        id:"e",
        value:{
            type:"range",
            min:-600,
            max:600,
            value:300,
            label:"TransX",
        },
    },
    f:{
        id:"f",
        value:{
            type:"range",
            min:-600,
            max:600,
            value:300,
            label:"TransY",
        },
    },
}

var runConfig = function (conf) {
    conf=conf?conf:processForm();
    let m = CM[conf.matrixId.value.value].M[conf.matrixIndex.value.value]
        svgConf = {
        svgId:"svg",
        templateId:"svg-template",
        parentId:"svg-parent",
        height:h,
        width:w,
        x:0,
        y:0,
    }
    updateForm(conf,m)
}

function updateSelect(selectId,options,appendOptions) {
    let sel = $(`#${selectId}`),
        len = options.length;

    if (!appendOptions) {
        sel.html("");
    }
    for (let i=0,opt;i<len;i++) {
        opt = options[i];
        sel.append(`<option value="${opt.value}">${(opt.text?opt.text:opt.value)}</option>\n`);
    }
}

function togglePanel(ids) {
    var id;
    for (i in arguments) {
        id = arguments[i];
        if (panelHidden) {
            $('#' + id).show();
        } else {
            $('#' + id).hide();
        }
    }
    panelHidden = !panelHidden;
    
}
window.addEventListener('DOMContentLoaded', () => {
    Log.Notice('Document Ready');
    Log.Remove();
    mrcmIdSelectArray = [];
    
    for (let i=0;i<CM.length;i++) {
        let mrcm = CM[i];
        mrcmIdSelectArray.push(
            {
                value:i,
                text:mrcm.desc,
                subMatrix:mrcm.M.length,
            }
        )
    }
    updateSelect("matrixId",mrcmIdSelectArray,true)
    setTimeout(togglePanel,20,'panel-matrix-options');
    captureR = [];
    let m = changeImage();
    updateForm(initialConf,m);
});

var addressStats = function (inArray,slice) {
    let stats = new Map(),
        len   = inArray.length,
        i     = 0;

    for (let key;i<len-slice;i++) {
        key = inArray.slice(i,slice+i).join("");
        if (!stats.get(key)) {
            stats.set(key,1);
        } else {
            stats.set(key,(stats.get(key)+1));
        }
    }
    return stats;
}

var addressStatsFromString = function (inArray,slice) {
    let stats = new Map(),
        len   = inArray.length,
        i     = 0;

    for (let key;i<len-slice;i++) {
        key = inArray.slice(i,slice+i);
        if (!stats.get(key)) { // change to stats.has(key)
            stats.set(key,1);
        } else {
            stats.set(key,(stats.get(key)+1));
        }
    }
    return stats;
}

var addressStatsIntKeys = function (inArray,slice) {
    let stats = new Map(),
        len   = inArray.length,
        i     = 0;

    for (let key;i<len-slice;i++) {
        key = parseInt(inArray.slice(i,slice+i).join(""));
        if (!stats.get(key)) {
            stats.set(key,1);
        } else {
            stats.set(key,(stats.get(key)+1));
        }
    }
    return stats;
}

var sortStatsByKey = function(m) {
    for (let [key,val] of m.keys()) {

    }
}
function getPerPixelHits(subP=false) {
    let hitMap = new Map(),
        subMap = new Map(),
        len = crObj.p.length,
        point = null,
        key,
        subDim = crObj.p[0].s,
        proto;

    for (let i=0;i<len;i++) {
        point = crObj.p[i]
        key = point.key;
        if (hitMap.has(key)) {
            hitMap.set(key,(hitMap.get(key)+1));
        } else {
            hitMap.set(key,1);
        }
        if (subP) {
            let idx = point.sy*subDim+point.sx;
            if (subMap.has(key)) {
                proto = subMap.get(key);
                proto[idx]++;
                subMap.set(key,proto);
            } else {
                proto = new Array(subDim*subDim).fill(0);
                proto[idx]=1;
                subMap.set(key,proto);
            }
        }
    }
    return {hitMap:hitMap,subMap:subMap};
}
</script>

<script src="https://ajax.googleapis.com/ajax/libs/d3js/3.5.17/d3.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script src="/js/log-2.js" charset="utf-8"></script>
<script src="/js/process-form.js" charset="utf-8"></script>
<script src="js/matrix2.js" charset="utf-8"></script>
<script src="js/mrcm-affine-demo.js" charset="utf-8"></script>
<script src="js/matrix-math.js" charset="utf-8"></script>
<script src="js/mrcm-lib.js" charset="utf-8"></script>

<!-- reuseable template for svg doc-->
<script id="svg-template" type="image/svg+xml">
<svg
    id="svgtmp"
    xmlns:svg="http://www.w3.org/2000/svg"
    xmlns="http://www.w3.org/2000/svg"
    xmlns:xlink="http://www.w3.org/1999/xlink"
    x="0"
    y="0"
    width="1000"
    height="1000"
    viewBox="0 0 1000 1000"
    >
<style>

</style>
<defs id="defs">
</defs>
<g id="main" transform="translate(0,0)">
    <rect id="bg" x="0" y="0" height="1" width="1" />

</g>
</svg>
</script>
<script id="svg-matrix-overlay" type="image/svg+xml">

<svg 
    id="svgtmp2"
    xmlns:svg="http://www.w3.org/2000/svg"
    xmlns="http://www.w3.org/2000/svg"
    xmlns:xlink="http://www.w3.org/1999/xlink" 
    x="0" 
    y="0" 
    height="600" 
    width="600" 
    viewBox="0 0 600 600"
    >
<style>
#svgtmp2 polyline {
    opacity: 1;
}
</style>
<defs id="defs2">

</defs>

<polyline id="box-0" x="0" y="0" points="0 0, 600 0, 600 600, 0 600" fill="#7f8" opacity=".5" stroke="tan" stroke-width="1" fill-rule="evenodd"  />
<polyline id="box-1" x="0" y="0" points="0 0, 600 0, 600 600, 0 600" fill="#acb" opacity=".5" stroke="orange" stroke-width="1" fill-rule="evenodd"  />
<polyline id="box-2" x="0" y="0" points="0 0, 600 0, 600 600, 0 600" fill="yellow" opacity=".5" stroke="blue" stroke-width="1" fill-rule="evenodd"  />
<polyline id="box-3" x="0" y="0" points="0 0, 600 0, 600 600, 0 600" fill="green" opacity=".5" stroke="aqua" stroke-width="1" fill-rule="evenodd"  />
<polyline id="box-4" x="0" y="0" points="0 0, 600 0, 600 600, 0 600" fill="tan" opacity=".5" stroke="red" stroke-width="1" fill-rule="evenodd"  />
<polyline id="box-5" x="0" y="0" points="0 0, 600 0, 600 600, 0 600" fill="silver" opacity=".5" stroke="black" stroke-width="1" fill-rule="evenodd"  />

</svg>
</script>
</body>
</html>
