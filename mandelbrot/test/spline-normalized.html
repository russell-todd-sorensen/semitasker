<!DOCTYPE HTML>
<html lang="en_US">
<head>
<meta charset="utf-8">

<title>Gradient Testing Underway</title>

<link rel="stylesheet" type="text/css" href="/css/log.css" media="all">
<style>
#controls input[type="number"] {
    width: 50px;

}

#controls {
    position: absolute;
    left: -2000px;
}
</style>

<script src="/js/d3.v3.js" type="application/javascript" language="javascript"></script>
<script type="text/javascript" src="/js/jquery-1.7.1.js"></script>
<script type="text/javascript" src="/js/jQuery.UI.Combined.1.8.20.1/Content/Scripts/jquery-ui-1.8.20.js"></script>
<script type="text/javascript" src="/js/log-2.js"></script>

<script src="/js/mouse-events-3.js"></script>
<script src="/js/example-library.js"></script>

<script>

var updateCurve = function (pathId, startId, control1Id, control2Id,
  endId,control1LineId,control2LineId)
{

    var x1 = $('#' + startId).attr('cx');
    var y1 = $('#' + startId).attr('cy');
    var x2 = $('#' + endId).attr('cx');
    var y2 = $('#' + endId).attr('cy');
    var c1x = $('#' + control1Id).attr('cx');
    var c1y = $('#' + control1Id).attr('cy');
    var c2x = $('#' + control2Id).attr('cx');
    var c2y = $('#' + control2Id).attr('cy');

    var d = 'M '  + x1  + ' ' + y1
         + ' C '  + c1x + ' ' + c1y
         + ' '    + c2x + ' ' + c2y
         + ' '    + x2  + ' ' + y2;

    $('#' + pathId).attr('d',d);
    $('#' + startId).attr('cx',x1).attr('cy',y1);
    $('#' + control1Id).attr('cx',c1x).attr('cy',c1y);
    $('#' + control2Id).attr('cx',c2x).attr('cy',c2y);
    $('#' + endId).attr('cx',x2).attr('cy',y2);
    $('#' + control1LineId).attr('x1',x1).attr('y1',y1).attr('x2',c1x).attr('y2',c1y);
    $('#' + control2LineId).attr('x1',c2x).attr('y1',c2y).attr('x2',x2).attr('y2',y2);
}

function doUpdate() {
    updateCurve('path1','circle1','circle2','circle3','circle4','control1','control2');
}

</script>
</head>
<body>

<svg
    id="svg1"
    height="1000"
    width="90%"
    xmlns:svg="http://www.w3.org/2000/svg"
    xmlns="http://www.w3.org/2000/svg"
    xmlns:xlink="http://www.w3.org/1999/xlink"
    >
<style>
svg {
    background-color: tan;
}

#c1,
#rect1 {
    fill: url(#grad1);
    stroke: silver;
    stroke-width: 4;
}

#b1 {
    fill: #abc;
}

.endpoints,
.controlpoints {
    fill: rgba(255,255,255,1);
    stroke: black;
    stroke-width: 1;
}

.lines {
    stroke: grey;
    stroke-width: 1;
}

</style>
<defs>
<linearGradient id="grad1">
 <stop offset="0%" stop-color="#ffcc00" stop-opacity="1.0" />
 <stop offset="100%" stop-color="#0099cc" stop-opacity="1.0"  />
</linearGradient>
<linearGradient id="grad3" xlink:href="#grad1" x1="0%" y1="0%" x2="100%" y2="100%" />
<use xlink:href="#grad1" id="grad2" x1="0%" y1="0%" x2="100%" y2="100%" />
</defs>
<g id="g1" transform="translate(100,100)">
    <rect x="-50" y="0" height="300" width="800" id="b1" />
    <rect x="0" y="50" height="200" width="700" id="rect1" />

  <path d="M 0 50 C 700 50 0 250 700 250" fill="none" stroke="orange" id="path1" />
  <circle cx="0" cy="50" r="5" class="endpoints" id="circle1" />
  <circle cx="700" cy="50" r="5" class="endpoints" id="circle2" />
  <line x1="0" y1="50" x2="700" y2="50" class="lines" id="control1" />

  <circle cx="0" cy="250" r="5" class="endpoints" id="circle3" />
  <circle cx="700" cy="250" r="5" class="endpoints" id="circle4" />
  <line x1="0" y1="250" x2="700" y2="250" class="lines" id="control2" />

</g>

</svg>

<table id="schedule" cellspacing="0" cellpadding="2" border="1">
</table>
<script>

function logStartMove(evt) {
    Log.Notice('logStartMove for ' + evt.data.name
        + ' was called evt.offsetX='
        + evt.offsetX
        + ' evt.offsetY='
        + evt.offsetY);
}

function logDragMove(evt) {
    Log.Notice('logDragMove was called evt.offsetX='
        + evt.offsetX
        + ' evt.offsetY='
        + evt.offsetY);
}

function logEndMove(evt) {
    Log.Notice('logEndMove was called evt.offsetX='
        + evt.offsetX
        + ' evt.offsetY='
        + evt.offsetY) ;
}

var moveControlPoint = function (evt) {
    var obj = evt.data;
    Log.Notice ('moveControlPoint on ' + obj.name);
    var cpId = '#' + obj.boxId;
    var radius = $(cpId).attr('r');
    var cx = evt.clientX-100-radius;
    var cy = evt.clientY-100-radius;
    $(cpId).attr('cx',cx);
    $(cpId).attr('cy',cy);
    doUpdate();
};

var ControlPoints = [];

var controlPoint = function (parentId,controlId,bindIds,x,y) {
    this.id = parentId;
    this.boxId = controlId;
    this.name = parentId;
    this.mouseBox = '#' + parentId;
    this.bindMoveElements = bindIds;
    this.x = x;
    this.y = y;
    this.dragStart = {
        x: x,
        y: y,
    };
    this.dragCurrent = {
        x: x,
        y: y,
    };
    this.dragEnd = {
        x: x,
        y: y,
    };

    this.callStartMove = [logStartMove,bindMouseUp];
    this.callDragMove  = [moveControlPoint];
    this.callEndMove   = [];
    return this;
};

var cp1 = new controlPoint('circle1','circle1',['svg1'],0,0);
var cp2 = new controlPoint('circle2','circle2',['svg1'],0,0);
var cp3 = new controlPoint('circle3','circle3',['svg1'],0,0);
var cp4 = new controlPoint('circle4','circle4',['svg1'],0,0);

var splineControls = [];

var Spline = function (startControl, endControl, startPoint, endPoint, defaults) {

    var splineId = 'spline' + splineControls.length;
    this.splineId = splineId;

    if (arguments.length < 1) {
        this.startControl = {
            id: splineId + '_' + 'circle2',
            x: 100,
            y: 0
        };
    } else {
        this.startControl = startControl;
    }

    if (arguments.length < 2) {
        this.endControl = {
            id: splineId + '_' + 'circle3',
            x: 0,
            y: 100
        };
    } else {
        this.endControl = endControl;
    }

    if (arguments.length < 3) {
        this.startPoint = {
            id: splineId + '_' + 'circle1',
            x: 100,
            y: 0
        };
    } else {
        this.startPoint = startPoint;
    }

    if (arguments.length < 4) {
        this.endPoint = {
            id: splineId + '_' + 'circle4',
            x: 0,
            y: 100
        };
    } else {
        this.endPoint = endPoint;
    }
    if (arguments.length < 5) {
        this.defaults = splineDefaults;
    } else {
        this.defaults = defaults;
    }

    this.pathId = splineId + '_path';
    this.svgId  = splineId + '_svg';
    splineControls[splineControls.length] = this;

    // generate svg Document
    var parent = d3.select(this.defaults.parentSelector);
    this.svg = parent.append('svg');
    this.defs = this.svg.append('defs');
    this.gradient = this.defs
        .append(this.defaults.gradient.type)
        .attr('id', this.defaults.gradient.id);

    var stop;
    for (var i = 0; i<this.defaults.gradient.stops.length; i++) {
        stop = this.defaults.gradient.stops[i];
        this.gradient
            .append('stop')
            .attr('id',stop.id)
            .attr('offset', stop.offset)
            .attr('stop-color', stop.stopColor)
            .attr('stop-opacity', stop.stopOpacity);
    }
    this.group = this.svg
        .append('g')
        .attr('id', this.defaults.translate.id)
        .attr('transform','translate('
            + this.defaults.translate.x
            + ', '
            + this.defaults.translate.y
            + ')'
        );

    var baseRect = this.defaults.baseRect;
    this.height = Math.abs(this.defaults.startPoint.y-this.defaults.endPoint.y);
    this.width  = Math.abs(this.defaults.endPoint.x-this.defaults.startPoint.x);
    this.svg
        .attr('height', this.height + 2*this.defaults.translate.y)
        .attr('width', this.width + 2*this.defaults.translate.x);

    this.group
        .append('rect')
        .attr('id', baseRect.id)
        .attr('x', 0)
        .attr('y', 0)
        .attr('height', this.height)
        .attr('width', this.width);
    this.d =   function() {
        return 'M '  + this.startPoint.x   + ' ' + this.startPoint.y
            + ' C '  + this.startControl.x + ' ' + this.startControl.y
            + ' '    + this.endControl.x   + ' ' + this.endControl.y
            + ' '    + this.endPoint.x     + ' ' + this.endPoint.y;
    };

    this.path = this.group
        .append('path')
        .attr('d', )
    return this;
}

var splineDefaults = {
    parentSelector: 'body',
    groupId: 'g1',
    gradient: {
        id: 'grad1',
        type: 'linearGradient',
        stops: [
            {
                id: 'stop1',
                offset: '0%',
                stopColor: "#ffcc00",
                stopOpacity: 1.0
            },
            {
                id: 'stop2',
                offset: '100%',
                stopColor: '#0099cc',
                stopOpacity: 1.0
            }
        ]
    },
    translate: {
        id: 'g1',
        x: 50,
        y: 50
    },
    baseRect: {
        id: 'rect1',
        x: 0,
        y: 0,
        height: 100,
        width: 100
    },
    startControl: {
        id: 'startControl',
        x: 100,
        y: 0
    },
    endControl: {
        id: 'endControl',
        x: 0,
        y: 100
    },
    startPoint: {
        id: 'startPoint',
        x: 100,
        y: 0
    },
    endPoint: {
        id: 'endPoint',
        x: 0,
        y: 100
    },
};

// Generates the static example:
var expSpline = new Spline (
    {id:'circle2',x:700,y:50},
    {id:'circle3',x:0,y:250},
    {id:'circle1',x:0,y:50},
    {id:'circle4',x:700,y:250}
)


var writeTable = function (tableId, pathId,valueBoxId) {

    var table, row, cell;
    table = d3.select('#' + tableId);
    table.html('');
    row = table.append('tr');
    cell = row.append('th');

    cell.text('Percent');
    cell = row.append('th');
    cell.text('X%')
    cell = row.append('th');
    cell.text('Y%')

    var path, pathLen;
    var boxPath;
    var startPoint, startX, startY;
    var endPoint, endX, endY;
    var bbox, xLength, yLength;

    path = document.getElementById(pathId);
    pathLen        = path.getTotalLength();
    startPoint     = path.getPointAtLength(0);
    startX         = startPoint.x;
    startY         = startPoint.y;
    endPoint       = path.getPointAtLength(pathLen);

    boxPath = document.getElementById(valueBoxId);
    bbox    = boxPath.getBBox();
    xLength = bbox.width;
    yLength = bbox.height;

    var point;
    for (var i = 0; i<101; i++) {
        point = path.getPointAtLength(pathLen*i/100);
        row = table.append('tr');
        cell = row.append('td');
        cell.text(i + '%')
        cell = row.append('td');
        cell.text(Math.round(Math.abs(point.x-startX)/xLength*10000)/100);
        cell = row.append('td');
        cell.text(Math.round(Math.abs(point.y-startY)/yLength*10000)/100);
    }
}

$(document).ready(function() {

    Log.Notice("jQuery Ready!");
    //Log.Hide();
    //Log.Remove();
    $(cp1.mouseBox).bind('mousedown',cp1,startMove);
    $(cp2.mouseBox).bind('mousedown',cp2,startMove);
    $(cp3.mouseBox).bind('mousedown',cp3,startMove);
    $(cp4.mouseBox).bind('mousedown',cp4,startMove);
    //writeTable('schedule','path1','rect1');
});

</script>
</body>
</html>
