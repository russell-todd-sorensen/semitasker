<!DOCTYPE html>
<html lang="en_US">
<head>
<meta charset="utf-8" >
<title>Color Mixer</title>
<link rel="stylesheet" type="text/css" href="http://ic00408/css/log.css" media="all">
<link rel="stylesheet" type="text/css" href="http://ic00408/js/jQuery.UI.Combined.1.8.20.1/Content/Content/themes/base/jquery.ui.all.css">
<link rel="stylesheet" href="http://ic00408/css/green-form.css" >

<style>

svg {
    background-color: #333;
}

.pointer {
    cursor: pointer;
}

#slider-box-1 {
    position: relative;
}

   

</style>
<!--<link rel="stylesheet" href="http://ic00408/css/box-model.css" >-->


<script src="http://ic00408/js/jquery-1.7.1.js"></script>
<script src="http://ic00408/js/jQuery.UI.Combined.1.8.20.1/Content/Scripts/jquery-ui-1.8.20.js"></script>
<script src="http://ic00408/js/d3.v3.js"></script>
<script src="http://ic00408/js/log-2.js"></script>
<script src="http://ic00408/js/data.js"></script>
<script src="http://ic00408/js/form-save-restore.js"></script>
<script src="http://ic00408/js/binary-hex-conversions.js"></script>
<script src="http://ic00408/js/example-library.js"></script>
<script src="http://ic00408/js/svg-transform.js"></script>

<script>
// <![CDATA[ 

var xyStart = new Object();
var swatches = new Array();

function startMove (evt) {
  
	 var mouseX = evt.pageX;
	 var mouseY = evt.pageY;
	 
	 xyStart["x"] = mouseX;
	 xyStart["y"] = mouseY;
	 var slider = evt.data.slider;
	 var mouseBox = evt.data.mouseBox;
	 
	 /* consider changing to startX, startY with lastX/Y over/under
	    to suppress changes.
	 
	 xyStart[slider] = {
  startX: 100,
  startY: 200,
  lastX: 150,
  lastY: 200,
  overX: false,
  underX: false,
  overY: true,
  underY: true
	 }
	 */
	 xyStart[slider] = [parseFloat($(slider).attr('x')),parseFloat($(slider).attr('y'))];
	 $(mouseBox)
	 	.bind('mousemove',evt.data,moveSlider)
	 	.bind('mouseup',evt.data,endMoveSlider);
}

function moveSlider (evt) {
  var mouseX = evt.pageX;
  var mouseY = evt.pageY;
	
  var dx = mouseX - xyStart["x"];
  var dy = mouseY - xyStart["y"];
  var slider = evt.data.slider;
	var skewX = evt.data.skewX;
	var skewY = evt.data.skewY;
	var currentX = xyStart[slider][0] + dx;
	var currentY = xyStart[slider][1] + dy;
	 
	 
	if (currentX > evt.data.maxX-skewX) {
  	currentX = evt.data.maxX-skewX;
	}
	else if (currentX < evt.data.minX-skewX) {
  	currentX = evt.data.minX-skewY;
	}
	 
	if (currentY > evt.data.maxY-skewY) {
  	currentY = evt.data.maxY-skewY;
	}
	else if (currentY < evt.data.minY-skewY) {
  	currentY = evt.data.minY-skewY;
	}
	 
	evt.data.currentX = currentX;
	evt.data.currentY = currentY;
	 
	switch (evt.data.orientation) {
	case 'vertical':
		$(slider).attr('y', currentY);
 		break;
	case 'horizontal':
	default:
		$(slider).attr('x', currentX);
 		break;
	}
 // callback function
	for (var i = 0; i< evt.data.call.length; i++) {
  	evt.data.call[i](evt);
	 }
}

function endMoveSlider (evt) {
	moveSlider(evt);
	$(evt.data.mouseBox)
		.unbind('mousemove')
		.unbind('mouseup');
}

function registerSliderMove (evt) {
	Log.Notice('new value=' + parseFloat(evt.data.currentX+evt.data.skewX));
}

function toHex(decimalNumber) {
	hexChars = "0123456789ABCDEF";
	if (decimalNumber > 255)
  return "??";
 
	var i = decimalNumber %16;
	var j = (decimalNumber - i)/16;
  return hexChars.charAt(j) + hexChars.charAt(i);
}

function toDecimal(hexNumber) {
	hexChars = "0123456789ABCDEF";
	var decimalNumber = 0;
	var hexCharValue;
	var exponent = 0;
	for (var i = hexNumber.length-1; i>= 0; i--) {
  	hexCharValue = hexChars.indexOf(hexNumber[i]);
  	decimalNumber = decimalNumber + hexCharValue * Math.pow(16, exponent++);
	}
  return decimalNumber;
}

function colorChange(evt) {
	
	// calculate new color  
	switch (evt.data.orientation) {
	case 'vertical':
		alert("colorChange: vertical not implemented!");
		return;
 	  break;
	case 'horizontal':
	default:
		var baseValue = evt.data.currentX+evt.data.skewX
 		var normValue = baseValue/(evt.data.maxX - evt.data.minX);
 		var rgbValue = Math.round(255 * normValue);
 		var hexValue = toHex(rgbValue);
		break;
	}
	
	evt.data.hexValue = hexValue;
	//evt.data.color = hexValue;
	
	Log.Notice('dec=' + rgbValue + ' hex=' + hexValue + ' backToDec =' + toDecimal(hexValue));
	
	for (var i = 0; i< evt.data.callParent.length; i++) {
   	evt.data.callParent[i](evt);
	}
}


function swatchUpdate(evt) {
	var swatch = evt.data.swatch;
	//var rgbValue = swatches[swatch].color();
	var rgbValue = evt.data.hexValue;
	Log.Notice('swatchUpdate rgbValue for ' + evt.data.slider + ' = ' + rgbValue + ' fullcolor =' + swatches[swatch].color());
	updateSwatch(swatch,evt.data.component,evt.data.hexValue)//evt.data.hexValue);
	$(swatch).attr('fill', swatches[swatch].color());
	swatches[swatch].updateGradients();
}

function getFullStopSelector (gradientStop) {
	return "#lg-" + gradientStop.id + "-" + gradientStop.offset;
}

var sliders = new Array();
sliders[0] = {
	slider:'#slider-1',
	swatch:'#swatch-1',
	stops: [{id: 1, offset: 0}, {id:1, offset: 100}],
	mouseBox:'body',
	minX:0,
	maxX:180,
	skewX:5,
	minY:0,
	maxY:180,
	skewY:5,
	orientation:'horizontal',
	component: 'r',
	hexValue:'87',
	call:[registerSliderMove,colorChange],
	callParent: [swatchUpdate]
}

sliders[1] = {
	slider:'#slider-2',
	swatch:'#swatch-1',
	stops: [{id: 2, offset: 0}, {id: 2, offset: 100}],
	mouseBox:'body',
	minX:0,
	maxX:180,
	skewX:5,
	minY:0,
	maxY:180,
	skewY:5,
	orientation:'horizontal',
	component: 'g',
	hexValue:'87',
	call:[registerSliderMove,colorChange],
	callParent: [swatchUpdate]
}

sliders[2] = {
	slider:'#slider-3',
	swatch:'#swatch-1',
	stops: [{id: 3, offset: 0}, {id: 3, offset: 100}],
	mouseBox:'body',
	minX:0,
	maxX:180,
	skewX:5,
	minY:0,
	maxY:180,
	skewY:5,
	orientation:'horizontal',
	component: 'b',
	hexValue:'87',
	call:[registerSliderMove,colorChange],
	callParent: [swatchUpdate]
}

swatches['#swatch-1'] = {
	r: '87',
	g: '87',
	b: '87',
	a: 1.0,
	sliders: [0,1,2],
	color: function () {
		return "#" + this.r + this.g + this.b;
	},
	stopColor: function (stopPercent, component) {

		var newVal = toHex(Math.round(stopPercent * 2.55));
		
		r = this.r;
		g = this.g;
		b = this.b;
		a = this.a;
		
		switch (component) {
		case 'r':
			r = newVal;
			break;
		case 'g':
			g = newVal;
			break;
		case 'b':
			b = newVal;
			break;
		}	
		return "#" + r + g + b;
	},
	updateGradients: function () {
		var currentSlider, sliderStop, gradientStopSelector;
		for (var i = 0; i < this.sliders.length; i++) {
			currentSlider = sliders[this.sliders[i]];
			for (var j = 0; j< currentSlider.stops.length; j++) {
				sliderStop = currentSlider.stops[j];
				gradientStopSelector = getFullStopSelector(sliderStop);
			$(gradientStopSelector).attr('stop-color', this.stopColor(sliderStop.offset,currentSlider.component));
			}
		}
	}
};

function updateSwatch (swatch, component, value) {
	swatches[swatch][component] = value;
}

$(document).ready(function(e) {
	$('#slider-1').bind('mousedown',sliders[0],startMove);
	$('#slider-2').bind('mousedown',sliders[1],startMove);
	$('#slider-3').bind('mousedown',sliders[2],startMove);
});

// ]]>
</script>

</head>
<body>

<div id="slider-box-1">
<svg id="gradient-image-1">
<defs>

<path id="triangle-2" d="M 5 5 L 10 10 L 0 10 Z"  />

<linearGradient id="gradient-1" gradientUnits="objectBoundingBox" color-interpolation="sRGB" >
 <stop offset="0%" stop-color="#008787" stop-opacity="1.0" id="lg-1-0" />
 <stop offset="100%" stop-color="#FF8787" stop-opacity="1.0" id="lg-1-100" />
</linearGradient>
<linearGradient id="gradient-2" gradientUnits="objectBoundingBox" color-interpolation="sRGB" >
 <stop offset="0%" stop-color="#870087" stop-opacity="1.0" id="lg-2-0" />
 <stop offset="100%" stop-color="#87FF87" stop-opacity="1.0" id="lg-2-100" />
</linearGradient>
<linearGradient id="gradient-3" gradientUnits="objectBoundingBox" color-interpolation="sRGB" >
 <stop offset="0%" stop-color="#878700" stop-opacity="1.0" id="lg-3-0" />
 <stop offset="100%" stop-color="#8787FF" stop-opacity="1.0" id="lg-3-100" />
</linearGradient>

<linearGradient id="gradient-4" gradientUnits="objectBoundingBox" color-interpolation="sRGB" >
 <stop offset="0%" stop-color="#FF0000" stop-opacity="1.0" id="lg-4-0" />
 <stop offset="33%" stop-color="#00FF00" stop-opacity="1.0" id="lg-4-33" />
 <stop offset="68%" stop-color="#0000FF" stop-opacity="1.0" id="lg-4-68" />
 <stop offset="100%" stop-color="#FF0000" stop-opacity="1.0" id="lg-4-100" />
</linearGradient>

</defs>

<g id="color-1" transform="translate(300, 150)" class="pointer">
 <rect id="swatch-1" x="0" y="-130" height="120" width="182" fill="#878787" stroke="#aaa" stroke-width="2" />
 <rect id="r1" x="1" y="1" height="5" width="180" fill="url(#gradient-1)" stroke="none" />
 <use id="slider-1" x="90" y="3" minX="0" maxX="180" xlink:href="#triangle-2" fill="000" stroke="#eee" stroke-width="1.5">
  <!-- <animate attributeName="x" from="0" to="90" begin="1s" dur="2s" /> -->
 </use>
 <rect id="r2" x="1" y="31" height="5" width="180" fill="url(#gradient-2)" stroke="none" />
 <use id="slider-2" x="90" y="33" minX="0" maxX="180" xlink:href="#triangle-2" fill="000" stroke="#eee" stroke-width="1.5" />
 <rect id="r3" x="1" y="61" height="5" width="180" fill="url(#gradient-3)" stroke="none" />
 <use id="slider-3" x="90" y="63" minX="0" maxX="180" xlink:href="#triangle-2" fill="000" stroke="#eee" stroke-width="1.5" />

 <!--  <rect id="r4" x="1" y="91" height="5" width="180" fill="url(#gradient-4)" stroke="none" /> -->
</g>

</svg>
<!--<div id="slider-1"><img src="triangle-slider-1.svg"></div>-->
</div>
</body>
</html>
